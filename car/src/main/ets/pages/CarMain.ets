import { BusinessError } from '@kit.BasicServicesKit';
import { promptAction } from '@kit.ArkUI';
import { DashboardDisplay } from '../components/DashboardDisplay';
import { MediaControlPanel } from '../components/MediaControlPanel';
import { ClimateControlPanel } from '../components/ClimateControlPanel';
import { VehicleAssistantManager } from '../../../shared/src/main/ets/manager/VehicleAssistantManager';
import { VehicleStatus, CommandParams, ControlCommand } from '../../../shared/src/main/ets/model/DeviceModel';

@Entry
@Component
struct CarMain {
  @State currentTab: string = 'dashboard'; // dashboard, media, climate
  @State vehicleStatus: VehicleStatus = {
    speed: 0,
    engineStatus: false,
    fuelLevel: 80,
    temperature: 22,
    doorLocked: true,
    latitude: 39.9042,
    longitude: 116.4074,
    updateTime: Date.now()
  };
  @State isLoading: boolean = true;
  
  private vehicleManager: VehicleAssistantManager = VehicleAssistantManager.getInstance();
  private dashboardRef: DashboardDisplay | null = null;

  aboutToAppear(): void {
    this.initializeApp();
  }

  build() {
    Column() {
      if (this.isLoading) {
        this.renderLoadingView()
      } else {
        // ä¸»å†…å®¹åŒºåŸŸ
        this.renderMainContent()
        
        // åº•éƒ¨å¯¼èˆªæ 
        this.renderBottomNavigation()
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  /**
   * æ¸²æŸ“åŠ è½½è§†å›¾
   */
  @Builder
  renderLoadingView() {
    Column() {
      Text('ğŸš—')
        .fontSize(48)
        .margin({ bottom: 16 })
      
      Text('è½¦è¾†ç³»ç»Ÿå¯åŠ¨ä¸­...')
        .fontSize(16)
        .fontColor('#666666')
      
      // å¯åŠ¨è¿›åº¦æ¡
      Progress({ value: 60, total: 100 })
        .width(200)
        .height(4)
        .margin({ top: 20 })
    }
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
  }

  /**
   * æ¸²æŸ“ä¸»å†…å®¹åŒºåŸŸ
   */
  @Builder
  renderMainContent() {
    Column() {
      // é¡¶éƒ¨çŠ¶æ€æ 
      this.renderStatusBar()
      
      // å†…å®¹åŒºåŸŸ
      this.renderContentArea()
    }
    .layoutWeight(1)
  }

  /**
   * æ¸²æŸ“çŠ¶æ€æ 
   */
  @Builder
  renderStatusBar() {
    Row() {
      Text('è½¦è½½ä¿¡æ¯ç³»ç»Ÿ')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor('#FFFFFF')
        .layoutWeight(1)
      
      // ç³»ç»Ÿæ—¶é—´
      Text(new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }))
        .fontSize(14)
        .fontColor('#EEEEEE')
    }
    .width('100%')
    .height(50)
    .padding({ left: 20, right: 20 })
    .backgroundColor('#2196F3')
    .justifyContent(FlexAlign.SpaceBetween)
  }

  /**
   * æ¸²æŸ“å†…å®¹åŒºåŸŸ
   */
  @Builder
  renderContentArea() {
    Scroll() {
      Column() {
        if (this.currentTab === 'dashboard') {
          // ä»ªè¡¨ç›˜è§†å›¾
          DashboardDisplay({
            vehicleStatus: this.vehicleStatus
          })
          .width('100%')
          .height(400)
          .margin({ bottom: 16 })
        } else if (this.currentTab === 'media') {
          // å¤šåª’ä½“æ§åˆ¶
          MediaControlPanel()
            .width('100%')
            .margin({ bottom: 16 })
        } else if (this.currentTab === 'climate') {
          // ç©ºè°ƒæ§åˆ¶
          ClimateControlPanel()
            .width('100%')
            .margin({ bottom: 16 })
        }
      }
      .padding(16)
    }
    .layoutWeight(1)
  }

  /**
   * æ¸²æŸ“åº•éƒ¨å¯¼èˆªæ 
   */
  @Builder
  renderBottomNavigation() {
    Row() {
      this.renderNavItem('dashboard', 'ä»ªè¡¨ç›˜', 'ğŸš—')
      this.renderNavItem('media', 'å¤šåª’ä½“', 'ğŸµ')
      this.renderNavItem('climate', 'ç©ºè°ƒ', 'â„ï¸')
    }
    .width('100%')
    .height(70)
    .backgroundColor('#FFFFFF')
    .border({ width: { top: 1 }, color: '#E0E0E0' })
    .justifyContent(FlexAlign.SpaceAround)
  }

  /**
   * æ¸²æŸ“å¯¼èˆªé¡¹
   */
  @Builder
  renderNavItem(tab: string, label: string, icon: string) {
    Column() {
      Text(icon)
        .fontSize(20)
        .fontColor(this.currentTab === tab ? '#2196F3' : '#999999')
        .margin({ bottom: 4 })
      
      Text(label)
        .fontSize(12)
        .fontColor(this.currentTab === tab ? '#2196F3' : '#999999')
    }
    .onClick(() => {
      this.currentTab = tab;
      console.info('Switched to tab:', tab);
    })
  }

  /**
   * åˆå§‹åŒ–åº”ç”¨ç¨‹åº
   */
  private async initializeApp(): Promise<void> {
    try {
      this.isLoading = true;
      
      // åˆå§‹åŒ–è½¦è¾†åŠ©æ‰‹ç®¡ç†å™¨
      const success = await this.vehicleManager.init(
        'com.example.wanwuhulian',
        'car_device_' + Date.now()
      );
      
      if (success) {
        // è®¾ç½®å›è°ƒç›‘å¬
        this.setupListeners();
        
        // å¯åŠ¨è½¦è¾†çŠ¶æ€æ¨¡æ‹Ÿ
        this.vehicleManager.startVehicleSimulation(1000);
        
        promptAction.showToast({
          message: 'è½¦è¾†ç³»ç»Ÿå¯åŠ¨æˆåŠŸ'
        });
      } else {
        promptAction.showToast({
          message: 'è½¦è¾†ç³»ç»Ÿå¯åŠ¨å¤±è´¥'
        });
      }
    } catch (error) {
      console.error('Car app initialization failed:', error);
      promptAction.showToast({
        message: 'ç³»ç»Ÿåˆå§‹åŒ–é”™è¯¯'
      });
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * è®¾ç½®ç›‘å¬å™¨
   */
  private setupListeners(): void {
    // è½¦è¾†çŠ¶æ€å˜åŒ–ç›‘å¬
    this.vehicleManager.setVehicleStatusListener((status) => {
      this.vehicleStatus = { ...status };
      // æ›´æ–°ä»ªè¡¨ç›˜æ˜¾ç¤º
      if (this.dashboardRef) {
        this.dashboardRef.updateStatus(status);
      }
    });
    
    // å‘½ä»¤æ¥æ”¶ç›‘å¬
    this.vehicleManager.setCommandReceivedListener((command) => {
      this.handleReceivedCommand(command);
    });
  }

  /**
   * å¤„ç†æ¥æ”¶åˆ°çš„å‘½ä»¤
   */
  private handleReceivedCommand(command: CommandParams): void {
    console.info('Received command in car:', command.command);
    
    switch (command.command) {
      case ControlCommand.START_ENGINE:
        promptAction.showToast({
          message: 'æ”¶åˆ°å¯åŠ¨å‘åŠ¨æœºæŒ‡ä»¤'
        });
        break;
      case ControlCommand.STOP_ENGINE:
        promptAction.showToast({
          message: 'æ”¶åˆ°åœæ­¢å‘åŠ¨æœºæŒ‡ä»¤'
        });
        break;
      case ControlCommand.LOCK_DOOR:
        promptAction.showToast({
          message: 'æ”¶åˆ°é”è½¦æŒ‡ä»¤'
        });
        break;
      case ControlCommand.UNLOCK_DOOR:
        promptAction.showToast({
          message: 'æ”¶åˆ°è§£é”æŒ‡ä»¤'
        });
        break;
      case ControlCommand.OPEN_AC:
        this.currentTab = 'climate';
        promptAction.showToast({
          message: 'ç©ºè°ƒå·²å¼€å¯'
        });
        break;
      case ControlCommand.PLAY_MUSIC:
        this.currentTab = 'media';
        promptAction.showToast({
          message: 'éŸ³ä¹æ’­æ”¾å·²å¯åŠ¨'
        });
        break;
      default:
        console.info('Unhandled command:', command.command);
    }
  }
}