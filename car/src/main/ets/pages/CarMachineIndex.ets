/**
 * è½¦æœºç«¯ä¸»é¡µ
 * 
 * æ ¸å¿ƒåŠŸèƒ½ï¼š
 * 1. åˆå§‹åŒ–åˆ†å¸ƒå¼æ•°æ®ç®¡ç†æ¨¡å—
 * 2. æ¥æ”¶æ‰‹æœºç«¯æ§åˆ¶æŒ‡ä»¤
 * 3. æ¨¡æ‹Ÿè½¦è¾†æ•°æ®ç”Ÿæˆ
 * 4. å“åº”æ‰‹è¡¨ç«¯å¯»è½¦æŒ‡ä»¤
 * 5. æ•´åˆå„åŠŸèƒ½é¢æ¿
 * 
 * @author è½¦è½½å¤šè®¾å¤‡ååŒåŠ©æ‰‹é¡¹ç›®ç»„
 * @version 1.0.0
 */

import { BusinessError } from '@kit.BasicServicesKit';
import { promptAction } from '@kit.ArkUI';
import { hilog } from '@kit.PerformanceAnalysisKit';

// å¯¼å…¥è‡ªå®šä¹‰ç»„ä»¶
import { NavigationPanel } from '../components/NavigationPanel';
import { MusicPanel } from '../components/MusicPanel';
import { ClimatePanel } from '../components/ClimatePanel';
import { DashboardPanel } from '../components/DashboardPanel';

// å¯¼å…¥å·¥å…·ç±»
import { VehicleDataSimulator, VehicleData } from '../utils/VehicleDataSimulator';
import { DistributedDataManager } from '../../../shared/src/main/ets/utils/DistributedDataManager';

@Entry
@Component
struct CarMachineIndex {
  // çŠ¶æ€ç®¡ç†
  @State currentTab: string = 'dashboard'; // å½“å‰é¡µé¢æ ‡ç­¾
  @State isConnected: boolean = false;     // åˆ†å¸ƒå¼è¿æ¥çŠ¶æ€
  @State deviceName: string = 'è½¦æœºç³»ç»Ÿ';   // è®¾å¤‡åç§°
  
  // ç»„ä»¶å¼•ç”¨
  @Provide() navPanel: NavigationPanel = new NavigationPanel();
  @Provide() musicPanel: MusicPanel = new MusicPanel();
  @Provide() climatePanel: ClimatePanel = new ClimatePanel();
  @Provide() dashboardPanel: DashboardPanel = new DashboardPanel();
  
  // å·¥å…·ç±»å®ä¾‹
  private vehicleSimulator: VehicleDataSimulator = VehicleDataSimulator.getInstance();
  private dataManager: DistributedDataManager = DistributedDataManager.getInstance();
  
  // ç§æœ‰å±æ€§
  private readonly TAG: string = 'CarMachineIndex';
  private deviceId: string = 'car_device_' + Date.now().toString();
  
  // ===== æ ¸å¿ƒé€»è¾‘ä½ç½®æ ‡æ³¨ =====
  // ä½ç½®1: é¡µé¢åˆå§‹åŒ–é€»è¾‘
  aboutToAppear(): void {
    this.initializeApp();
  }
  
  // ä½ç½®2: é¡µé¢é”€æ¯æ¸…ç†é€»è¾‘
  aboutToDisappear(): void {
    this.cleanup();
  }
  
  build() {
    Column() {
      // é¡¶éƒ¨çŠ¶æ€æ 
      this.renderStatusBar()
      
      // ä¸»è¦å†…å®¹åŒºåŸŸ
      this.renderMainContent()
      
      // åº•éƒ¨å¯¼èˆªæ 
      this.renderBottomNavigation()
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#000000')
  }
  
  /**
   * æ¸²æŸ“çŠ¶æ€æ 
   */
  @Builder
  private renderStatusBar() {
    Row() {
      // è®¾å¤‡ä¿¡æ¯
      Column() {
        Text(this.deviceName)
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor('#FFFFFF')
        
        Text(this.isConnected ? 'å·²è¿æ¥' : 'æœªè¿æ¥')
          .fontSize(12)
          .fontColor(this.isConnected ? '#4CAF50' : '#F44336')
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)
      
      // ç³»ç»Ÿæ—¶é—´
      Text(new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }))
        .fontSize(16)
        .fontColor('#FFFFFF')
    }
    .width('100%')
    .height(60)
    .padding({ left: 20, right: 20 })
    .backgroundColor('#1E1E1E')
    .justifyContent(FlexAlign.SpaceBetween)
  }
  
  /**
   * æ¸²æŸ“ä¸»è¦å†…å®¹åŒºåŸŸ
   */
  @Builder
  private renderMainContent() {
    Scroll() {
      Column() {
        // æ ¹æ®å½“å‰æ ‡ç­¾æ˜¾ç¤ºä¸åŒé¢æ¿
        If (this.currentTab === 'dashboard') {
          // ===== æ ¸å¿ƒé€»è¾‘ä½ç½®3: ä»ªè¡¨ç›˜æ•°æ®æ›´æ–° =====
          this.dashboardPanel
            .width('100%')
            .margin({ bottom: 16 })
        }
        
        If (this.currentTab === 'navigation') {
          this.navPanel
            .width('100%')
            .margin({ bottom: 16 })
        }
        
        If (this.currentTab === 'music') {
          this.musicPanel
            .width('100%')
            .margin({ bottom: 16 })
        }
        
        If (this.currentTab === 'climate') {
          this.climatePanel
            .width('100%')
            .margin({ bottom: 16 })
        }
      }
      .padding(16)
    }
    .layoutWeight(1)
  }
  
  /**
   * æ¸²æŸ“åº•éƒ¨å¯¼èˆªæ 
   */
  @Builder
  private renderBottomNavigation() {
    Row() {
      this.renderNavButton('dashboard', 'ä»ªè¡¨ç›˜', 'ğŸš—')
      this.renderNavButton('navigation', 'å¯¼èˆª', 'ğŸ§­')
      this.renderNavButton('music', 'éŸ³ä¹', 'ğŸµ')
      this.renderNavButton('climate', 'ç©ºè°ƒ', 'â„ï¸')
    }
    .width('100%')
    .height(70)
    .backgroundColor('#1E1E1E')
    .border({ width: { top: 1 }, color: '#333333' })
    .justifyContent(FlexAlign.SpaceAround)
  }
  
  /**
   * æ¸²æŸ“å¯¼èˆªæŒ‰é’®
   */
  @Builder
  private renderNavButton(tab: string, label: string, icon: string) {
    Column() {
      Text(icon)
        .fontSize(20)
        .fontColor(this.currentTab === tab ? '#4CAF50' : '#AAAAAA')
        .margin({ bottom: 4 })
      
      Text(label)
        .fontSize(12)
        .fontColor(this.currentTab === tab ? '#4CAF50' : '#AAAAAA')
    }
    .onClick(() => {
      this.switchTab(tab);
    })
  }
  
  // ===== æ ¸å¿ƒé€»è¾‘ä½ç½®4: åº”ç”¨åˆå§‹åŒ– =====
  /**
   * åˆå§‹åŒ–åº”ç”¨ç¨‹åº
   */
  private async initializeApp(): Promise<void> {
    try {
      hilog.info(0x0000, this.TAG, 'Initializing car machine application');
      
      // åˆå§‹åŒ–åˆ†å¸ƒå¼æ•°æ®ç®¡ç†
      await this.initializeDistributedData();
      
      // å¯åŠ¨è½¦è¾†æ•°æ®æ¨¡æ‹Ÿ
      this.startVehicleSimulation();
      
      // è®¾ç½®æ•°æ®ç›‘å¬
      this.setupDataListeners();
      
      // æ˜¾ç¤ºåˆå§‹åŒ–æˆåŠŸæç¤º
      promptAction.showToast({
        message: 'è½¦æœºç³»ç»Ÿå¯åŠ¨æˆåŠŸ'
      });
      
      hilog.info(0x0000, this.TAG, 'Car machine application initialized successfully');
    } catch (error) {
      hilog.error(0x0000, this.TAG, 'Failed to initialize application: %{public}s', 
                 JSON.stringify(error));
      promptAction.showToast({
        message: 'ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥'
      });
    }
  }
  
  // ===== æ ¸å¿ƒé€»è¾‘ä½ç½®5: åˆ†å¸ƒå¼æ•°æ®åˆå§‹åŒ– =====
  /**
   * åˆå§‹åŒ–åˆ†å¸ƒå¼æ•°æ®ç®¡ç†
   */
  private async initializeDistributedData(): Promise<void> {
    const success = await this.dataManager.init(this.deviceId);
    if (success) {
      this.isConnected = true;
      
      // æ³¨å†Œæ•°æ®å˜æ›´ç›‘å¬
      this.dataManager.onDataChanged(this.handleRemoteDataChange);
      
      // æ³¨å†Œè¿æ¥çŠ¶æ€ç›‘å¬
      this.dataManager.onConnectionStatusChanged(this.handleConnectionStatusChange);
      
      hilog.info(0x0000, this.TAG, 'Distributed data manager initialized');
    } else {
      hilog.error(0x0000, this.TAG, 'Failed to initialize distributed data manager');
    }
  }
  
  // ===== æ ¸å¿ƒé€»è¾‘ä½ç½®6: è½¦è¾†æ•°æ®æ¨¡æ‹Ÿå¯åŠ¨ =====
  /**
   * å¯åŠ¨è½¦è¾†æ•°æ®æ¨¡æ‹Ÿ
   */
  private startVehicleSimulation(): void {
    // è®¢é˜…è½¦è¾†æ•°æ®æ›´æ–°
    this.vehicleSimulator.subscribe(this.handleVehicleDataUpdate);
    
    // å¼€å§‹æ¨¡æ‹Ÿ
    this.vehicleSimulator.startSimulation();
    
    hilog.info(0x0000, this.TAG, 'Vehicle data simulation started');
  }
  
  // ===== æ ¸å¿ƒé€»è¾‘ä½ç½®7: æ•°æ®ç›‘å¬è®¾ç½® =====
  /**
   * è®¾ç½®æ•°æ®ç›‘å¬å™¨
   */
  private setupDataListeners(): void {
    // è®¾ç½®å®šæ—¶åŒæ­¥åˆ°åˆ†å¸ƒå¼å­˜å‚¨
    setInterval(() => {
      const currentData = this.vehicleSimulator.getCurrentData();
      this.syncVehicleData(currentData);
    }, 2000); // æ¯2ç§’åŒæ­¥ä¸€æ¬¡
  }
  
  // ===== æ ¸å¿ƒé€»è¾‘ä½ç½®8: è½¦è¾†æ•°æ®æ›´æ–°å¤„ç† =====
  /**
   * å¤„ç†è½¦è¾†æ•°æ®æ›´æ–°
   */
  private handleVehicleDataUpdate = (data: VehicleData): void => {
    // æ›´æ–°ä»ªè¡¨ç›˜æ˜¾ç¤º
    this.dashboardPanel.updateVehicleData(data);
    
    hilog.debug(0x0000, this.TAG, 'Vehicle data updated: speed=%{public}d, fuel=%{public}d%%', 
               data.speed, data.fuelLevel);
  }
  
  // ===== æ ¸å¿ƒé€»è¾‘ä½ç½®9: è¿œç¨‹æ•°æ®å˜æ›´å¤„ç† =====
  /**
   * å¤„ç†è¿œç¨‹æ•°æ®å˜æ›´ï¼ˆæ¥æ”¶æ‰‹æœºç«¯æŒ‡ä»¤ï¼‰
   */
  private handleRemoteDataChange = (data: any): void => {
    hilog.info(0x0000, this.TAG, 'Received remote data change: %{public}s', JSON.stringify(data));
    
    // å¤„ç†å¯¼èˆªæŒ‡ä»¤
    if (data.navigationDestination) {
      this.navPanel.updateNavigation(data.navigationDestination);
      this.switchTab('navigation');
    }
    
    // å¤„ç†éŸ³ä¹æ§åˆ¶æŒ‡ä»¤
    if (data.hasOwnProperty('isMusicPlaying')) {
      this.musicPanel.setPlayState(data.isMusicPlaying);
      this.switchTab('music');
    }
    
    // å¤„ç†ç©ºè°ƒæ§åˆ¶æŒ‡ä»¤
    if (data.acTemperature) {
      this.climatePanel.setTargetTemperature(data.acTemperature);
      this.switchTab('climate');
    }
    
    if (data.hasOwnProperty('isAcOn')) {
      this.climatePanel.setAcState(data.isAcOn);
    }
    
    // å¤„ç†å¯»è½¦æŒ‡ä»¤ï¼ˆæ‰‹è¡¨ç«¯ï¼‰
    if (data.findCarCommand) {
      this.handleFindCarCommand();
    }
  }
  
  // ===== æ ¸å¿ƒé€»è¾‘ä½ç½®10: è¿æ¥çŠ¶æ€å˜æ›´å¤„ç† =====
  /**
   * å¤„ç†è¿æ¥çŠ¶æ€å˜æ›´
   */
  private handleConnectionStatusChange = (status: any): void => {
    this.isConnected = status === 'connected';
    hilog.info(0x0000, this.TAG, 'Connection status changed to: %{public}s', status);
  }
  
  // ===== æ ¸å¿ƒé€»è¾‘ä½ç½®11: æ•°æ®åŒæ­¥åˆ°åˆ†å¸ƒå¼å­˜å‚¨ =====
  /**
   * åŒæ­¥è½¦è¾†æ•°æ®åˆ°åˆ†å¸ƒå¼å­˜å‚¨
   */
  private async syncVehicleData(data: VehicleData): Promise<void> {
    try {
      await this.dataManager.storeVehicleData({
        fuelLevel: data.fuelLevel,
        tirePressure: data.tirePressure,
        speed: data.speed
      });
      hilog.debug(0x0000, this.TAG, 'Vehicle data synced to distributed storage');
    } catch (error) {
      hilog.error(0x0000, this.TAG, 'Failed to sync vehicle data: %{public}s', 
                 JSON.stringify(error));
    }
  }
  
  // ===== æ ¸å¿ƒé€»è¾‘ä½ç½®12: å¯»è½¦æŒ‡ä»¤å¤„ç† =====
  /**
   * å¤„ç†å¯»è½¦æŒ‡ä»¤ï¼ˆå“åº”æ‰‹è¡¨ç«¯"ä¸€é”®å¯»è½¦"ï¼‰
   */
  private handleFindCarCommand(): void {
    hilog.info(0x0000, this.TAG, 'Find car command received');
    
    // æ˜¾ç¤ºå¯»è½¦æç¤º
    promptAction.showDialog({
      title: 'å¯»è½¦æé†’',
      message: 'è½¦è¾†é¸£ç¬›+åŒé—ªå¼€å¯\nè¯·å‰å¾€è½¦è¾†ä½ç½®',
      buttons: [
        {
          text: 'ç¡®å®š',
          color: '#4CAF50'
        }
      ]
    });
    
    // æ¨¡æ‹Ÿè½¦è¾†å“åº”æ•ˆæœ
    setTimeout(() => {
      promptAction.showToast({
        message: 'è½¦è¾†å·²åœ¨å“é“ƒå’Œé—ªçƒ' 
      });
    }, 1000);
  }
  
  /**
   * åˆ‡æ¢é¡µé¢æ ‡ç­¾
   */
  private switchTab(tab: string): void {
    this.currentTab = tab;
    hilog.info(0x0000, this.TAG, 'Switched to tab: %{public}s', tab);
  }
  
  /**
   * æ¸…ç†èµ„æº
   */
  private cleanup(): void {
    try {
      // åœæ­¢è½¦è¾†æ¨¡æ‹Ÿ
      this.vehicleSimulator.stopSimulation();
      this.vehicleSimulator.unsubscribe(this.handleVehicleDataUpdate);
      
      // ç§»é™¤æ•°æ®ç›‘å¬
      this.dataManager.removeDataListener(this.handleRemoteDataChange);
      this.dataManager.removeConnectionListener(this.handleConnectionStatusChange);
      
      hilog.info(0x0000, this.TAG, 'Application cleanup completed');
    } catch (error) {
      hilog.error(0x0000, this.TAG, 'Error during cleanup: %{public}s', JSON.stringify(error));
    }
  }
}