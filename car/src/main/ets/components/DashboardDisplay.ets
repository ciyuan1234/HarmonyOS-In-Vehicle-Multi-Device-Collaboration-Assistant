import { VehicleStatus } from '../../../../shared/src/main/ets/model/DeviceModel';
import { formatSpeed, formatFuelLevel, formatTemperature } from '../../../../shared/src/main/ets/utils/CommonUtils';

/**
 * è½¦è¾†ä»ªè¡¨ç›˜ç»„ä»¶
 * æ˜¾ç¤ºæ ¸å¿ƒé©¾é©¶ä¿¡æ¯
 */
@Component
export struct DashboardDisplay {
  @State vehicleStatus: VehicleStatus = {
    speed: 0,
    engineStatus: false,
    fuelLevel: 80,
    temperature: 22,
    doorLocked: true,
    latitude: 39.9042,
    longitude: 116.4074,
    updateTime: Date.now()
  };

  build() {
    Column() {
      // é€Ÿåº¦è¡¨
      this.renderSpeedometer()
      
      // çŠ¶æ€æŒ‡ç¤ºå™¨
      this.renderStatusIndicators()
      
      // è¾…åŠ©ä¿¡æ¯
      this.renderAuxiliaryInfo()
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#000000')
    .padding(20)
  }

  /**
   * æ¸²æŸ“é€Ÿåº¦è¡¨
   */
  @Builder
  renderSpeedometer() {
    Stack() {
      // å¤–åœˆ
      Circle()
        .width(200)
        .height(200)
        .strokeWidth(8)
        .stroke(Color.Gray)
        .fill('#00000000')
      
      // è¿›åº¦å¼§
      Circle()
        .width(200)
        .height(200)
        .strokeWidth(8)
        .stroke(this.getSpeedColor())
        .fill('#00000000')
        .strokeDashArray([Math.PI * 200 * (this.vehicleStatus.speed / 120), Math.PI * 200])
        .strokeDashOffset(0)
      
      // é€Ÿåº¦æ•°å­—
      Column() {
        Text(formatSpeed(this.vehicleStatus.speed))
          .fontSize(48)
          .fontWeight(FontWeight.Bold)
          .fontColor('#FFFFFF')
        
        Text('km/h')
          .fontSize(16)
          .fontColor('#AAAAAA')
          .margin({ top: 4 })
      }
      .alignItems(HorizontalAlign.Center)
    }
    .width(220)
    .height(220)
    .margin({ bottom: 30 })
  }

  /**
   * æ¸²æŸ“çŠ¶æ€æŒ‡ç¤ºå™¨
   */
  @Builder
  renderStatusIndicators() {
    Row() {
      // å‘åŠ¨æœºçŠ¶æ€
      this.renderIndicator(
        this.vehicleStatus.engineStatus ? 'ğŸŸ¢' : 'ğŸ”´',
        'å‘åŠ¨æœº',
        this.vehicleStatus.engineStatus ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢'
      )
      
      // è½¦é—¨çŠ¶æ€
      this.renderIndicator(
        this.vehicleStatus.doorLocked ? 'ğŸ”’' : 'ğŸ”“',
        'è½¦é—¨',
        this.vehicleStatus.doorLocked ? 'å·²é”å®š' : 'æœªé”å®š'
      )
      
      // ç‡ƒæ²¹çŠ¶æ€
      this.renderIndicator(
        'â›½',
        'ç‡ƒæ²¹',
        formatFuelLevel(this.vehicleStatus.fuelLevel)
      )
      
      // æ¸©åº¦çŠ¶æ€
      this.renderIndicator(
        'ğŸŒ¡ï¸',
        'æ¸©åº¦',
        formatTemperature(this.vehicleStatus.temperature)
      )
    }
    .width('100%')
    .justifyContent(FlexAlign.SpaceAround)
    .margin({ bottom: 30 })
  }

  /**
   * æ¸²æŸ“å•ä¸ªæŒ‡ç¤ºå™¨
   */
  @Builder
  renderIndicator(icon: string, label: string, value: string) {
    Column() {
      Text(icon)
        .fontSize(24)
        .margin({ bottom: 8 })
      
      Text(label)
        .fontSize(12)
        .fontColor('#AAAAAA')
        .margin({ bottom: 4 })
      
      Text(value)
        .fontSize(14)
        .fontWeight(FontWeight.Medium)
        .fontColor('#FFFFFF')
    }
    .alignItems(HorizontalAlign.Center)
  }

  /**
   * æ¸²æŸ“è¾…åŠ©ä¿¡æ¯
   */
  @Builder
  renderAuxiliaryInfo() {
    Row() {
      // GPSçŠ¶æ€
      Row() {
        Text('ğŸ“')
          .fontSize(16)
          .margin({ right: 4 })
        
        Text('GPSå®šä½')
          .fontSize(12)
          .fontColor('#AAAAAA')
      }
      .layoutWeight(1)
      
      // æ—¶é—´æ˜¾ç¤º
      Text(new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }))
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor('#FFFFFF')
    }
    .width('100%')
  }

  /**
   * æ ¹æ®é€Ÿåº¦è·å–é¢œè‰²
   */
  private getSpeedColor(): Color {
    if (this.vehicleStatus.speed < 60) {
      return Color.Green;
    } else if (this.vehicleStatus.speed < 100) {
      return Color.Yellow;
    } else {
      return Color.Red;
    }
  }

  /**
   * æ›´æ–°è½¦è¾†çŠ¶æ€
   */
  updateStatus(status: VehicleStatus): void {
    this.vehicleStatus = { ...status };
  }
}