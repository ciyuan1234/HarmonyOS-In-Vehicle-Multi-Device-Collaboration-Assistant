/**
 * è½¦è¾†ä»ªè¡¨ç›˜ç»„ä»¶
 * 
 * åŠŸèƒ½æè¿°ï¼š
 * 1. å®æ—¶æ˜¾ç¤ºè½¦è¾†æ ¸å¿ƒæ•°æ®ï¼ˆæ²¹é‡ã€èƒå‹ã€è½¦é€Ÿï¼‰
 * 2. æ•°æ®æ¥è‡ªVehicleDataSimulator
 * 3. æ”¯æŒæ•°æ®è®¢é˜…æ›´æ–°
 * 
 * @author è½¦è½½å¤šè®¾å¤‡ååŒåŠ©æ‰‹é¡¹ç›®ç»„
 */

import { VehicleData } from '../utils/VehicleDataSimulator';
import { hilog } from '@kit.PerformanceAnalysisKit';

@Component
export struct DashboardPanel {
  @State vehicleData: VehicleData = {
    fuelLevel: 85,
    tirePressure: 2.35,
    speed: 60,
    engineStatus: true,
    updateTime: Date.now()
  };
  
  private readonly TAG: string = 'DashboardPanel';
  
  build() {
    Column() {
      // é¢æ¿æ ‡é¢˜
      Text('ğŸš— è½¦è¾†ä»ªè¡¨ç›˜')
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor('#FFFFFF')
        .width('100%')
        .padding({ bottom: 20 })
      
      // æ ¸å¿ƒæ•°æ®æ˜¾ç¤ºåŒº
      Row() {
        // è½¦é€Ÿæ˜¾ç¤º
        this.renderSpeedGauge()
        
        // æ²¹é‡å’Œèƒå‹æ˜¾ç¤º
        Column() {
          this.renderFuelIndicator()
          this.renderTirePressureIndicator()
        }
        .layoutWeight(1)
        .padding({ left: 20 })
      }
      .width('100%')
      .padding({ bottom: 20 })
      
      // è¯¦ç»†æ•°æ®åˆ—è¡¨
      Column() {
        this.renderDataItem('å‘åŠ¨æœºçŠ¶æ€', 
                          this.vehicleData.engineStatus ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢',
                          this.vehicleData.engineStatus ? '#4CAF50' : '#F44336')
        
        this.renderDataItem('æœ€åæ›´æ–°', 
                          new Date(this.vehicleData.updateTime).toLocaleTimeString(),
                          '#AAAAAA')
      }
      .width('100%')
    }
    .width('100%')
    .backgroundColor('#1E1E1E')
    .borderRadius(16)
    .padding(20)
  }
  
  /**
   * æ¸²æŸ“è½¦é€Ÿè¡¨
   */
  @Builder
  private renderSpeedGauge() {
    Column() {
      // è½¦é€Ÿæ•°å­—
      Text(`${this.vehicleData.speed}`)
        .fontSize(48)
        .fontWeight(FontWeight.Bold)
        .fontColor(this.getSpeedColor())
        .margin({ bottom: 8 })
      
      // å•ä½å’Œæ ‡ç­¾
      Text('km/h')
        .fontSize(16)
        .fontColor('#AAAAAA')
        .margin({ bottom: 20 })
      
      // é€Ÿåº¦ç­‰çº§æŒ‡ç¤º
      Row() {
        Text('ä½é€Ÿ')
          .fontSize(12)
          .fontColor('#4CAF50')
        
        Blank()
        
        Text('ä¸­é€Ÿ')
          .fontSize(12)
          .fontColor('#FFC107')
        
        Blank()
        
        Text('é«˜é€Ÿ')
          .fontSize(12)
          .fontColor('#F44336')
      }
      .width('100%')
    }
    .layoutWeight(1)
    .alignItems(HorizontalAlign.Center)
  }
  
  /**
   * æ¸²æŸ“æ²¹é‡æŒ‡ç¤ºå™¨
   */
  @Builder
  private renderFuelIndicator() {
    Row() {
      Column() {
        // æ²¹é‡å›¾æ ‡
        Text('â›½')
          .fontSize(24)
          .margin({ bottom: 8 })
        
        // æ²¹é‡ç™¾åˆ†æ¯”
        Text(`${this.vehicleData.fuelLevel.toFixed(1)}%`)
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.getFuelColor())
          .margin({ bottom: 4 })
        
        // æ²¹é‡çŠ¶æ€æ–‡å­—
        Text(this.getFuelStatusText())
          .fontSize(12)
          .fontColor('#AAAAAA')
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Center)
      
      // æ²¹é‡è¿›åº¦æ¡
      Column() {
        ProgressBar({ value: this.vehicleData.fuelLevel, total: 100 })
          .width(8)
          .height(60)
          .color(this.getFuelColor())
          .backgroundColor('#333333')
          .layoutWeight(1)
      }
      .width(20)
      .height(80)
      .justifyContent(FlexAlign.Center)
    }
    .width('100%')
    .padding({ bottom: 20 })
  }
  
  /**
   * æ¸²æŸ“èƒå‹æŒ‡ç¤ºå™¨
   */
  @Builder
  private renderTirePressureIndicator() {
    Row() {
      Column() {
        // èƒå‹å›¾æ ‡
        Text('ğŸ›')
          .fontSize(24)
          .margin({ bottom: 8 })
        
        // èƒå‹æ•°å€¼
        Text(`${this.vehicleData.tirePressure.toFixed(2)}`)
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.getTirePressureColor())
          .margin({ bottom: 4 })
        
        // èƒå‹å•ä½å’ŒçŠ¶æ€
        Text('bar')
          .fontSize(12)
          .fontColor('#AAAAAA')
          .margin({ bottom: 2 })
        
        Text(this.getTirePressureStatus())
          .fontSize(10)
          .fontColor(this.getTirePressureColor())
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Center)
      
      // èƒå‹çŠ¶æ€æŒ‡ç¤º
      Column() {
        ForEach([2.5, 2.4, 2.3, 2.2], (threshold: number) => {
          Circle()
            .width(8)
            .height(8)
            .fill(this.vehicleData.tirePressure >= threshold ? 
                  this.getTirePressureColor() : '#333333')
            .margin({ bottom: 4 })
        })
      }
      .width(20)
      .height(80)
      .justifyContent(FlexAlign.SpaceAround)
    }
    .width('100%')
  }
  
  /**
   * æ¸²æŸ“æ•°æ®é¡¹
   */
  @Builder
  private renderDataItem(label: string, value: string, color: string) {
    Row() {
      Text(label)
        .fontSize(14)
        .fontColor('#AAAAAA')
        .layoutWeight(1)
      
      Text(value)
        .fontSize(14)
        .fontColor(color)
    }
    .width('100%')
    .padding({ vertical: 8 })
  }
  
  /**
   * æ ¹æ®è½¦é€Ÿè·å–é¢œè‰²
   */
  private getSpeedColor(): string {
    if (this.vehicleData.speed < 60) {
      return '#4CAF50'; // ç»¿è‰² - ä½é€Ÿ
    } else if (this.vehicleData.speed < 100) {
      return '#FFC107'; // é»„è‰² - ä¸­é€Ÿ
    } else {
      return '#F44336'; // çº¢è‰² - é«˜é€Ÿ
    }
  }
  
  /**
   * æ ¹æ®æ²¹é‡è·å–é¢œè‰²
   */
  private getFuelColor(): string {
    if (this.vehicleData.fuelLevel > 50) {
      return '#4CAF50'; // ç»¿è‰² - å……è¶³
    } else if (this.vehicleData.fuelLevel > 20) {
      return '#FFC107'; // é»„è‰² - ä¸€èˆ¬
    } else {
      return '#F44336'; // çº¢è‰² - ä¸è¶³
    }
  }
  
  /**
   * è·å–æ²¹é‡çŠ¶æ€æ–‡å­—
   */
  private getFuelStatusText(): string {
    if (this.vehicleData.fuelLevel > 50) {
      return 'å……è¶³';
    } else if (this.vehicleData.fuelLevel > 20) {
      return 'ä¸€èˆ¬';
    } else {
      return 'ä¸è¶³';
    }
  }
  
  /**
   * æ ¹æ®èƒå‹è·å–é¢œè‰²
   */
  private getTirePressureColor(): string {
    if (this.vehicleData.tirePressure >= 2.2 && this.vehicleData.tirePressure <= 2.5) {
      return '#4CAF50'; // ç»¿è‰² - æ­£å¸¸
    } else if (this.vehicleData.tirePressure >= 2.0 && this.vehicleData.tirePressure <= 2.7) {
      return '#FFC107'; // é»„è‰² - è­¦å‘Š
    } else {
      return '#F44336'; // çº¢è‰² - å±é™©
    }
  }
  
  /**
   * è·å–èƒå‹çŠ¶æ€æè¿°
   */
  private getTirePressureStatus(): string {
    if (this.vehicleData.tirePressure >= 2.2 && this.vehicleData.tirePressure <= 2.5) {
      return 'æ­£å¸¸';
    } else if (this.vehicleData.tirePressure < 2.2) {
      return 'åä½';
    } else {
      return 'åé«˜';
    }
  }
  
  /**
   * æ›´æ–°è½¦è¾†æ•°æ®
   */
  updateVehicleData(data: VehicleData): void {
    this.vehicleData = { ...data };
    hilog.debug(0x0000, this.TAG, 'Dashboard updated with new vehicle data');
  }
}