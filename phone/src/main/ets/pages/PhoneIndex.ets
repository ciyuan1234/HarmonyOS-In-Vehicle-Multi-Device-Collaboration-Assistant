/**
 * æ‰‹æœºç«¯ä¸»é¡µ
 * 
 * æ ¸å¿ƒåŠŸèƒ½ï¼š
 * 1. åˆ†å¸ƒå¼è®¾å¤‡å‘ç°å’Œè¿æ¥ç®¡ç†
 * 2. è½¦è¾†è¿œç¨‹æ§åˆ¶åŠŸèƒ½
 * 3. å®æ—¶è½¦è¾†çŠ¶æ€ç›‘æ§
 * 4. ç®€æ´ç›´è§‚çš„æ‰‹æœºUIé€‚é…
 * 
 * @author è½¦è½½å¤šè®¾å¤‡ååŒåŠ©æ‰‹é¡¹ç›®ç»„
 * @version 1.0.0
 */

import { BusinessError } from '@kit.BasicServicesKit';
import { promptAction } from '@kit.ArkUI';
import { hilog } from '@kit.PerformanceAnalysisKit';

// å¯¼å…¥è‡ªå®šä¹‰ç»„ä»¶
import { DeviceDiscoveryPanel } from '../components/DeviceDiscoveryPanel';
import { VehicleControlPanel } from '../components/VehicleControlPanel';
import { VehicleStatusPanel } from '../components/VehicleStatusPanel';

// å¯¼å…¥å·¥å…·ç±»
import { DeviceDiscoveryManager } from '../utils/DeviceDiscoveryManager';
import { DistributedDataManager } from '../../../shared/src/main/ets/utils/DistributedDataManager';

@Entry
@Component
struct PhoneIndex {
  // çŠ¶æ€ç®¡ç†
  @State currentTab: string = 'control'; // control, status, devices
  @State isConnected: boolean = false;   // åˆ†å¸ƒå¼è¿æ¥çŠ¶æ€
  @State deviceName: string = 'æˆ‘çš„æ‰‹æœº'; // è®¾å¤‡åç§°
  
  // ç»„ä»¶å¼•ç”¨
  @Provide() devicePanel: DeviceDiscoveryPanel = new DeviceDiscoveryPanel();
  @Provide() controlPanel: VehicleControlPanel = new VehicleControlPanel();
  @Provide() statusPanel: VehicleStatusPanel = new VehicleStatusPanel();
  
  // å·¥å…·ç±»å®ä¾‹
  private discoveryManager: DeviceDiscoveryManager = DeviceDiscoveryManager.getInstance();
  private dataManager: DistributedDataManager = DistributedDataManager.getInstance();
  
  // ç§æœ‰å±æ€§
  private readonly TAG: string = 'PhoneIndex';
  private deviceId: string = 'phone_device_' + Date.now().toString();
  
  aboutToAppear(): void {
    this.initializeApp();
  }
  
  aboutToDisappear(): void {
    this.cleanup();
  }
  
  build() {
    Column() {
      // é¡¶éƒ¨çŠ¶æ€æ 
      this.renderStatusBar()
      
      // ä¸»è¦å†…å®¹åŒºåŸŸ
      this.renderMainContent()
      
      // åº•éƒ¨å¯¼èˆªæ 
      this.renderBottomNavigation()
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }
  
  /**
   * æ¸²æŸ“çŠ¶æ€æ 
   */
  @Builder
  private renderStatusBar() {
    Row() {
      Column() {
        Text(this.deviceName)
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#FFFFFF')
        
        Text(this.isConnected ? 'å·²è¿æ¥è½¦æœºç³»ç»Ÿ' : 'æœªè¿æ¥')
          .fontSize(12)
          .fontColor(this.isConnected ? '#C8E6C9' : '#FFCDD2')
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)
      
      // ç³»ç»Ÿæ—¶é—´å’Œè¿æ¥æŒ‡ç¤ºå™¨
      Row() {
        If (this.isConnected) {
          Circle()
            .width(8)
            .height(8)
            .fill('#4CAF50')
            .margin({ right: 8 })
        }
        
        Text(new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }))
          .fontSize(14)
          .fontColor('#FFFFFF')
      }
    }
    .width('100%')
    .height(60)
    .padding({ left: 16, right: 16 })
    .backgroundColor('#2196F3')
    .justifyContent(FlexAlign.SpaceBetween)
  }
  
  /**
   * æ¸²æŸ“ä¸»è¦å†…å®¹åŒºåŸŸ
   */
  @Builder
  private renderMainContent() {
    Scroll() {
      Column() {
        // æ ¹æ®å½“å‰æ ‡ç­¾æ˜¾ç¤ºä¸åŒé¢æ¿
        If (this.currentTab === 'control') {
          // è½¦è¾†æ§åˆ¶é¢æ¿
          this.controlPanel
            .width('100%')
            .margin({ bottom: 16 })
        }
        
        If (this.currentTab === 'status') {
          // è½¦è¾†çŠ¶æ€é¢æ¿
          this.statusPanel
            .width('100%')
            .margin({ bottom: 16 })
        }
        
        If (this.currentTab === 'devices') {
          // è®¾å¤‡å‘ç°é¢æ¿
          this.devicePanel
            .width('100%')
            .margin({ bottom: 16 })
        }
      }
      .padding(16)
    }
    .layoutWeight(1)
  }
  
  /**
   * æ¸²æŸ“åº•éƒ¨å¯¼èˆªæ 
   */
  @Builder
  private renderBottomNavigation() {
    Row() {
      this.renderNavButton('control', 'æ§åˆ¶', 'ğŸ®')
      this.renderNavButton('status', 'çŠ¶æ€', 'ğŸ“Š')
      this.renderNavButton('devices', 'è®¾å¤‡', 'ğŸ“±')
    }
    .width('100%')
    .height(70)
    .backgroundColor('#FFFFFF')
    .border({ width: { top: 1 }, color: '#E0E0E0' })
    .justifyContent(FlexAlign.SpaceAround)
  }
  
  /**
   * æ¸²æŸ“å¯¼èˆªæŒ‰é’®
   */
  @Builder
  private renderNavButton(tab: string, label: string, icon: string) {
    Column() {
      Text(icon)
        .fontSize(20)
        .fontColor(this.currentTab === tab ? '#2196F3' : '#999999')
        .margin({ bottom: 4 })
      
      Text(label)
        .fontSize(12)
        .fontColor(this.currentTab === tab ? '#2196F3' : '#999999')
    }
    .onClick(() => {
      this.switchTab(tab);
    })
  }
  
  /**
   * åˆå§‹åŒ–åº”ç”¨ç¨‹åº
   */
  private async initializeApp(): Promise<void> {
    try {
      hilog.info(0x0000, this.TAG, 'Initializing phone application');
      
      // åˆå§‹åŒ–è®¾å¤‡å‘ç°ç®¡ç†å™¨
      const discoverySuccess = await this.discoveryManager.init();
      
      // åˆå§‹åŒ–åˆ†å¸ƒå¼æ•°æ®ç®¡ç†
      const dataSuccess = await this.dataManager.init(this.deviceId);
      
      if (discoverySuccess && dataSuccess) {
        this.isConnected = true;
        
        // æ³¨å†Œè¿æ¥çŠ¶æ€ç›‘å¬
        this.dataManager.onConnectionStatusChanged(this.handleConnectionStatusChange);
        
        promptAction.showToast({
          message: 'æ‰‹æœºç«¯ç³»ç»Ÿå¯åŠ¨æˆåŠŸ'
        });
        
        hilog.info(0x0000, this.TAG, 'Phone application initialized successfully');
      } else {
        promptAction.showToast({
          message: 'ç³»ç»Ÿåˆå§‹åŒ–éƒ¨åˆ†å¤±è´¥'
        });
      }
    } catch (error) {
      hilog.error(0x0000, this.TAG, 'Failed to initialize application: %{public}s', 
                 JSON.stringify(error));
      promptAction.showToast({
        message: 'ç³»ç»Ÿåˆå§‹åŒ–é”™è¯¯'
      });
    }
  }
  
  /**
   * å¤„ç†è¿æ¥çŠ¶æ€å˜æ›´
   */
  private handleConnectionStatusChange = (status: any): void => {
    this.isConnected = status === 'connected';
    hilog.info(0x0000, this.TAG, 'Connection status changed to: %{public}s', status);
  }
  
  /**
   * åˆ‡æ¢é¡µé¢æ ‡ç­¾
   */
  private switchTab(tab: string): void {
    this.currentTab = tab;
    hilog.info(0x0000, this.TAG, 'Switched to tab: %{public}s', tab);
  }
  
  /**
   * æ¸…ç†èµ„æº
   */
  private cleanup(): void {
    try {
      // åœæ­¢è®¾å¤‡å‘ç°
      this.discoveryManager.stopScanning();
      
      // ç§»é™¤ç›‘å¬å™¨
      this.dataManager.removeConnectionListener(this.handleConnectionStatusChange);
      
      hilog.info(0x0000, this.TAG, 'Application cleanup completed');
    } catch (error) {
      hilog.error(0x0000, this.TAG, 'Error during cleanup: %{public}s', JSON.stringify(error));
    }
  }
}