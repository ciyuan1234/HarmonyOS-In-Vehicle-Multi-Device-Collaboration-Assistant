import { BusinessError } from '@kit.BasicServicesKit';
import { promptAction } from '@kit.ArkUI';
import { DeviceItem } from '../components/DeviceItem';
import { VehicleControlPanel } from '../components/VehicleControlPanel';
import { QuickActionCard } from '../components/QuickActionCard';
import { VehicleAssistantManager } from '../../../shared/src/main/ets/manager/VehicleAssistantManager';
import { DeviceInfo, DeviceType, ControlCommand, VehicleStatus } from '../../../shared/src/main/ets/model/DeviceModel';

@Entry
@Component
struct PhoneMain {
  @State deviceList: DeviceInfo[] = [];
  @State vehicleStatus: VehicleStatus = {
    speed: 0,
    engineStatus: false,
    fuelLevel: 80,
    temperature: 22,
    doorLocked: true,
    latitude: 39.9042,
    longitude: 116.4074,
    updateTime: Date.now()
  };
  @State isLoading: boolean = true;
  
  private vehicleManager: VehicleAssistantManager = VehicleAssistantManager.getInstance();

  aboutToAppear(): void {
    this.initializeApp();
  }

  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜æ 
      this.renderHeader()
      
      // å†…å®¹åŒºåŸŸ
      if (this.isLoading) {
        this.renderLoadingView()
      } else {
        Scroll() {
          Column() {
            // å¿«æ·æ“ä½œåŒºåŸŸ
            this.renderQuickActions()
            
            // è½¦è¾†æ§åˆ¶é¢æ¿
            this.renderVehicleControl()
            
            // è®¾å¤‡åˆ—è¡¨
            this.renderDeviceList()
          }
          .padding(16)
        }
        .layoutWeight(1)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  /**
   * æ¸²æŸ“é¡¶éƒ¨æ ‡é¢˜æ 
   */
  @Builder
  renderHeader() {
    Row() {
      Column() {
        Text('è½¦è½½å¤šè®¾å¤‡ååŒåŠ©æ‰‹')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#FFFFFF')
        
        Text('æ‰‹æœºæ§åˆ¶ä¸­å¿ƒ')
          .fontSize(12)
          .fontColor('#EEEEEE')
          .margin({ top: 2 })
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)
      
      // åˆ·æ–°æŒ‰é’®
      Button('ğŸ”„')
        .width(40)
        .height(40)
        .backgroundColor('#FFFFFF20')
        .borderRadius(20)
        .onClick(() => {
          this.refreshData();
        })
    }
    .width('100%')
    .height(80)
    .padding({ left: 16, right: 16 })
    .backgroundColor('#2196F3')
    .justifyContent(FlexAlign.SpaceBetween)
  }

  /**
   * æ¸²æŸ“åŠ è½½è§†å›¾
   */
  @Builder
  renderLoadingView() {
    Column() {
      Text('ğŸš—')
        .fontSize(48)
        .margin({ bottom: 16 })
      
      Text('æ­£åœ¨åˆå§‹åŒ–ç³»ç»Ÿ...')
        .fontSize(16)
        .fontColor('#666666')
    }
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
  }

  /**
   * æ¸²æŸ“å¿«æ·æ“ä½œåŒºåŸŸ
   */
  @Builder
  renderQuickActions() {
    Column() {
      Text('å¿«æ·æ“ä½œ')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor('#333333')
        .margin({ bottom: 12 })
        .selfAlign(ItemAlign.Start)
      
      Grid() {
        // å¯åŠ¨å‘åŠ¨æœº
        GridItem() {
          QuickActionCard({
            title: 'å¯åŠ¨è½¦è¾†',
            icon: 'ğŸ”‘',
            backgroundColor: '#4CAF50',
            command: ControlCommand.START_ENGINE,
            onAction: this.handleQuickAction
          })
        }
        
        // é”è½¦
        GridItem() {
          QuickActionCard({
            title: 'è¿œç¨‹é”è½¦',
            icon: 'ğŸ”’',
            backgroundColor: '#FF9800',
            command: ControlCommand.LOCK_DOOR,
            onAction: this.handleQuickAction
          })
        }
        
        // ç©ºè°ƒæ§åˆ¶
        GridItem() {
          QuickActionCard({
            title: 'å¼€å¯ç©ºè°ƒ',
            icon: 'â„ï¸',
            backgroundColor: '#2196F3',
            command: ControlCommand.OPEN_AC,
            onAction: this.handleQuickAction
          })
        }
        
        // å¯»è½¦
        GridItem() {
          QuickActionCard({
            title: 'å¯»æ‰¾è½¦è¾†',
            icon: 'ğŸ”',
            backgroundColor: '#9C27B0',
            command: ControlCommand.NAVIGATE_TO,
            onAction: this.handleQuickAction
          })
        }
      }
      .columnsTemplate('1fr 1fr')
      .rowsTemplate('1fr 1fr')
      .columnsGap(12)
      .rowsGap(12)
    }
    .width('100%')
    .margin({ bottom: 20 })
  }

  /**
   * æ¸²æŸ“è½¦è¾†æ§åˆ¶é¢æ¿
   */
  @Builder
  renderVehicleControl() {
    VehicleControlPanel({
      vehicleStatus: this.vehicleStatus,
      onSendCommand: this.handleVehicleCommand
    })
    .margin({ bottom: 20 })
  }

  /**
   * æ¸²æŸ“è®¾å¤‡åˆ—è¡¨
   */
  @Builder
  renderDeviceList() {
    Column() {
      Row() {
        Text('è¿æ¥è®¾å¤‡')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
          .layoutWeight(1)
        
        Text(`${this.deviceList.length} ä¸ªè®¾å¤‡`)
          .fontSize(12)
          .fontColor('#999999')
      }
      .width('100%')
      .margin({ bottom: 12 })
      
      // è®¾å¤‡åˆ—è¡¨
      ForEach(this.deviceList, (device: DeviceInfo) => {
        DeviceItem({
          device: device,
          onSelect: this.handleDeviceSelect
        })
      }, (item: DeviceInfo) => item.deviceId)
      
      // ç©ºçŠ¶æ€
      if (this.deviceList.length === 0) {
        Column() {
          Text('ğŸ“±')
            .fontSize(48)
            .margin({ bottom: 16 })
          
          Text('æš‚æ— è¿æ¥è®¾å¤‡')
            .fontSize(14)
            .fontColor('#999999')
        }
        .width('100%')
        .height(200)
        .justifyContent(FlexAlign.Center)
      }
    }
    .width('100%')
  }

  /**
   * åˆå§‹åŒ–åº”ç”¨ç¨‹åº
   */
  private async initializeApp(): Promise<void> {
    try {
      this.isLoading = true;
      
      // åˆå§‹åŒ–è½¦è¾†åŠ©æ‰‹ç®¡ç†å™¨
      const success = await this.vehicleManager.init(
        'com.example.wanwuhulian',
        'phone_device_' + Date.now()
      );
      
      if (success) {
        // è®¾ç½®å›è°ƒç›‘å¬
        this.setupListeners();
        
        // è·å–åˆå§‹æ•°æ®
        this.refreshData();
        
        promptAction.showToast({
          message: 'ç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸ'
        });
      } else {
        promptAction.showToast({
          message: 'ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥'
        });
      }
    } catch (error) {
      console.error('App initialization failed:', error);
      promptAction.showToast({
        message: 'åˆå§‹åŒ–å‡ºé”™: ' + (error as Error).message
      });
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * è®¾ç½®ç›‘å¬å™¨
   */
  private setupListeners(): void {
    // è®¾å¤‡åˆ—è¡¨å˜åŒ–ç›‘å¬
    this.vehicleManager.setDeviceListListener((devices) => {
      this.deviceList = [...devices];
    });
    
    // è½¦è¾†çŠ¶æ€å˜åŒ–ç›‘å¬
    this.vehicleManager.setVehicleStatusListener((status) => {
      this.vehicleStatus = { ...status };
    });
  }

  /**
   * åˆ·æ–°æ•°æ®
   */
  private refreshData(): void {
    // è·å–æœ€æ–°è®¾å¤‡åˆ—è¡¨
    const devices = this.vehicleManager.getDeviceList();
    this.deviceList = [...devices];
    
    // è·å–æœ€æ–°è½¦è¾†çŠ¶æ€
    const status = this.vehicleManager.getCurrentVehicleStatus();
    this.vehicleStatus = { ...status };
    
    console.info('Data refreshed');
  }

  /**
   * å¤„ç†å¿«æ·æ“ä½œ
   */
  private handleQuickAction = (command: ControlCommand, device?: DeviceInfo): void => {
    console.info('Quick action triggered:', command);
    
    // å‘é€å‘½ä»¤åˆ°ç›®æ ‡è®¾å¤‡
    this.vehicleManager.sendCommand(command, device?.deviceId)
      .then(success => {
        if (success) {
          promptAction.showToast({
            message: 'å‘½ä»¤å‘é€æˆåŠŸ'
          });
        } else {
          promptAction.showToast({
            message: 'å‘½ä»¤å‘é€å¤±è´¥'
          });
        }
      })
      .catch(error => {
        console.error('Failed to send command:', error);
        promptAction.showToast({
          message: 'å‘é€å‘½ä»¤æ—¶å‡ºé”™'
        });
      });
  }

  /**
   * å¤„ç†è½¦è¾†æ§åˆ¶å‘½ä»¤
   */
  private handleVehicleCommand = (command: ControlCommand, params?: any): void => {
    console.info('Vehicle command triggered:', command, params);
    
    this.vehicleManager.sendCommand(command, undefined, params)
      .then(success => {
        if (success) {
          promptAction.showToast({
            message: 'è½¦è¾†æ§åˆ¶å‘½ä»¤å·²å‘é€'
          });
        }
      });
  }

  /**
   * å¤„ç†è®¾å¤‡é€‰æ‹©
   */
  private handleDeviceSelect = (device: DeviceInfo): void => {
    console.info('Device selected:', device.deviceName);
    
    promptAction.showToast({
      message: `é€‰æ‹©äº†è®¾å¤‡: ${device.deviceName}`
    });
    
    // å¯ä»¥åœ¨è¿™é‡Œæ‰“å¼€è®¾å¤‡è¯¦æƒ…æˆ–æ‰§è¡Œè®¾å¤‡ç‰¹å®šæ“ä½œ
  }
}