/**
 * è®¾å¤‡å‘ç°é¢æ¿ç»„ä»¶
 * 
 * åŠŸèƒ½æè¿°ï¼š
 * 1. æ˜¾ç¤ºå¯è¿æ¥çš„è®¾å¤‡åˆ—è¡¨
 * 2. æ”¯æŒä¸€é”®è¿æ¥/æ–­å¼€è®¾å¤‡
 * 3. æ˜¾ç¤ºè®¾å¤‡çŠ¶æ€å’Œä¿¡æ¯
 * 
 * @author è½¦è½½å¤šè®¾å¤‡ååŒåŠ©æ‰‹é¡¹ç›®ç»„
 */

import { DeviceInfo, DeviceDiscoveryManager } from '../utils/DeviceDiscoveryManager';
import { hilog } from '@kit.PerformanceAnalysisKit';

@Component
export struct DeviceDiscoveryPanel {
  @State devices: DeviceInfo[] = [];
  @State isScanning: boolean = false;
  
  private discoveryManager: DeviceDiscoveryManager = DeviceDiscoveryManager.getInstance();
  private readonly TAG: string = 'DeviceDiscoveryPanel';
  
  aboutToAppear(): void {
    this.initializePanel();
  }
  
  build() {
    Column() {
      // é¢æ¿æ ‡é¢˜å’Œæ§åˆ¶æŒ‰é’®
      this.renderHeader()
      
      // è®¾å¤‡åˆ—è¡¨
      this.renderDeviceList()
    }
    .width('100%')
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
    .padding(16)
    .shadow({ radius: 6, color: '#00000010', offsetX: 0, offsetY: 2 })
  }
  
  /**
   * æ¸²æŸ“é¢æ¿å¤´éƒ¨
   */
  @Builder
  private renderHeader() {
    Row() {
      Column() {
        Text('ğŸ“± è®¾å¤‡å‘ç°')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')
        
        Text(`${this.devices.length} ä¸ªè®¾å¤‡`)
          .fontSize(12)
          .fontColor('#999999')
          .margin({ top: 2 })
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)
      
      // åˆ·æ–°æŒ‰é’®
      Button('ğŸ”„')
        .width(36)
        .height(36)
        .backgroundColor('#F5F5F5')
        .fontColor('#666666')
        .borderRadius(18)
        .margin({ right: 8 })
        .onClick(() => {
          this.refreshDevices();
        })
      
      // æ‰«æçŠ¶æ€æŒ‡ç¤ºå™¨
      If (this.isScanning) {
        LoadingProgress()
          .width(20)
          .height(20)
          .color('#2196F3')
      }
    }
    .width('100%')
    .margin({ bottom: 16 })
  }
  
  /**
   * æ¸²æŸ“è®¾å¤‡åˆ—è¡¨
   */
  @Builder
  private renderDeviceList() {
    If (this.devices.length === 0) {
      this.renderEmptyState()
    } else {
      Column() {
        ForEach(this.devices, (device: DeviceInfo) => {
          this.renderDeviceItem(device)
        }, (item: DeviceInfo) => item.deviceId)
      }
    }
  }
  
  /**
   * æ¸²æŸ“ç©ºçŠ¶æ€
   */
  @Builder
  private renderEmptyState() {
    Column() {
      Text('ğŸ”')
        .fontSize(48)
        .margin({ bottom: 16 })
      
      Text('æš‚æœªå‘ç°å¯è¿æ¥è®¾å¤‡')
        .fontSize(14)
        .fontColor('#999999')
      
      Text('è¯·ç¡®ä¿è®¾å¤‡åœ¨åŒä¸€ç½‘ç»œä¸‹')
        .fontSize(12)
        .fontColor('#CCCCCC')
        .margin({ top: 4 })
    }
    .width('100%')
    .height(200)
    .justifyContent(FlexAlign.Center)
  }
  
  /**
   * æ¸²æŸ“è®¾å¤‡é¡¹
   */
  @Builder
  private renderDeviceItem(device: DeviceInfo) {
    Row() {
      // è®¾å¤‡å›¾æ ‡
      this.renderDeviceIcon(device.deviceType)
      
      // è®¾å¤‡ä¿¡æ¯
      Column() {
        Row() {
          Text(device.deviceName)
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#333333')
            .layoutWeight(1)
          
          // è®¾å¤‡ç±»å‹æ ‡ç­¾
          Text(this.getDeviceTypeLabel(device.deviceType))
            .fontSize(10)
            .fontColor('#FFFFFF')
            .backgroundColor(this.getDeviceTypeColor(device.deviceType))
            .borderRadius(8)
            .padding({ left: 6, right: 6, top: 2, bottom: 2 })
        }
        .width('100%')
        .margin({ bottom: 4 })
        
        // çŠ¶æ€ä¿¡æ¯è¡Œ
        Row() {
          // åœ¨çº¿çŠ¶æ€
          Row() {
            Circle()
              .width(8)
              .height(8)
              .fill(device.isOnline ? '#4CAF50' : '#999999')
              .margin({ right: 4 })
            
            Text(device.isOnline ? 'åœ¨çº¿' : 'ç¦»çº¿')
              .fontSize(12)
              .fontColor(device.isOnline ? '#4CAF50' : '#999999')
          }
          .margin({ right: 12 })
          
          // ä¿¡å·å¼ºåº¦
          Row() {
            Text('ğŸ“¶')
              .fontSize(12)
              .margin({ right: 2 })
            
            Text(`${device.signalStrength}%`)
              .fontSize(12)
              .fontColor('#666666')
          }
          .margin({ right: 12 })
          
          // ç”µæ± ç”µé‡
          Row() {
            Text('ğŸ”‹')
              .fontSize(12)
              .margin({ right: 2 })
            
            Text(`${device.batteryLevel}%`)
              .fontSize(12)
              .fontColor('#666666')
          }
        }
        .width('100%')
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)
      
      // è¿æ¥æŒ‰é’®
      this.renderConnectButton(device)
    }
    .width('100%')
    .padding(12)
    .backgroundColor('#FAFAFA')
    .borderRadius(8)
    .margin({ bottom: 8 })
  }
  
  /**
   * æ¸²æŸ“è®¾å¤‡å›¾æ ‡
   */
  @Builder
  private renderDeviceIcon(deviceType: string) {
    Row() {
      Switch (deviceType) {
        Case ('phone'):
          Text('ğŸ“±')
            .fontSize(24)
        Case ('car'):
          Text('ğŸš—')
            .fontSize(24)
        Case ('watch'):
          Text('âŒš')
            .fontSize(24)
        default:
          Text('ğŸ“±')
            .fontSize(24)
      }
    }
    .width(40)
    .height(40)
    .backgroundColor('#E3F2FD')
    .borderRadius(20)
    .justifyContent(FlexAlign.Center)
    .margin({ right: 12 })
  }
  
  /**
   * æ¸²æŸ“è¿æ¥æŒ‰é’®
   */
  @Builder
  private renderConnectButton(device: DeviceInfo) {
    Button(device.isConnected ? 'æ–­å¼€' : 'è¿æ¥')
      .width(60)
      .height(32)
      .fontSize(12)
      .backgroundColor(device.isConnected ? '#F44336' : '#2196F3')
      .fontColor('#FFFFFF')
      .borderRadius(16)
      .onClick(() => {
        if (device.isConnected) {
          this.disconnectDevice(device.deviceId);
        } else {
          this.connectDevice(device.deviceId);
        }
      })
  }
  
  /**
   * åˆå§‹åŒ–é¢æ¿
   */
  private async initializePanel(): Promise<void> {
    try {
      // æ³¨å†Œè®¾å¤‡çŠ¶æ€å˜æ›´ç›‘å¬
      this.discoveryManager.onDeviceStatusChange(this.handleDeviceListChange);
      
      // è·å–åˆå§‹è®¾å¤‡åˆ—è¡¨
      this.refreshDevices();
      
      hilog.info(0x0000, this.TAG, 'DeviceDiscoveryPanel initialized');
    } catch (error) {
      hilog.error(0x0000, this.TAG, 'Failed to initialize panel: %{public}s', 
                 JSON.stringify(error));
    }
  }
  
  /**
   * åˆ·æ–°è®¾å¤‡åˆ—è¡¨
   */
  private async refreshDevices(): Promise<void> {
    this.isScanning = true;
    
    try {
      // æ¨¡æ‹Ÿæ‰«æè¿‡ç¨‹
      await new Promise(resolve => setTimeout(resolve, 1500));
      
      const devices = this.discoveryManager.getOnlineDevices();
      this.devices = [...devices];
      
      hilog.info(0x0000, this.TAG, 'Devices refreshed, found %{public}d devices', 
                 this.devices.length);
    } catch (error) {
      hilog.error(0x0000, this.TAG, 'Failed to refresh devices: %{public}s', 
                 JSON.stringify(error));
    } finally {
      this.isScanning = false;
    }
  }
  
  /**
   * è¿æ¥è®¾å¤‡
   */
  private async connectDevice(deviceId: string): Promise<void> {
    try {
      const success = await this.discoveryManager.connectToDevice(deviceId);
      if (success) {
        // æ›´æ–°æœ¬åœ°çŠ¶æ€
        const device = this.devices.find(d => d.deviceId === deviceId);
        if (device) {
          device.isConnected = true;
        }
        hilog.info(0x0000, this.TAG, 'Device connected successfully: %{public}s', deviceId);
      }
    } catch (error) {
      hilog.error(0x0000, this.TAG, 'Failed to connect device: %{public}s', 
                 JSON.stringify(error));
    }
  }
  
  /**
   * æ–­å¼€è®¾å¤‡è¿æ¥
   */
  private async disconnectDevice(deviceId: string): Promise<void> {
    try {
      const success = await this.discoveryManager.disconnectDevice(deviceId);
      if (success) {
        // æ›´æ–°æœ¬åœ°çŠ¶æ€
        const device = this.devices.find(d => d.deviceId === deviceId);
        if (device) {
          device.isConnected = false;
        }
        hilog.info(0x0000, this.TAG, 'Device disconnected successfully: %{public}s', deviceId);
      }
    } catch (error) {
      hilog.error(0x0000, this.TAG, 'Failed to disconnect device: %{public}s', 
                 JSON.stringify(error));
    }
  }
  
  /**
   * å¤„ç†è®¾å¤‡åˆ—è¡¨å˜æ›´
   */
  private handleDeviceListChange = (devices: DeviceInfo[]): void => {
    this.devices = [...devices.filter(device => device.isOnline)];
    hilog.debug(0x0000, this.TAG, 'Device list updated, %{public}d devices', this.devices.length);
  }
  
  /**
   * è·å–è®¾å¤‡ç±»å‹æ ‡ç­¾
   */
  private getDeviceTypeLabel(deviceType: string): string {
    switch (deviceType) {
      case 'phone': return 'æ‰‹æœº';
      case 'car': return 'è½¦æœº';
      case 'watch': return 'æ‰‹è¡¨';
      default: return 'æœªçŸ¥';
    }
  }
  
  /**
   * è·å–è®¾å¤‡ç±»å‹é¢œè‰²
   */
  private getDeviceTypeColor(deviceType: string): string {
    switch (deviceType) {
      case 'phone': return '#2196F3';
      case 'car': return '#4CAF50';
      case 'watch': return '#FF9800';
      default: return '#9E9E9E';
    }
  }
  
  /**
   * ç»„ä»¶é”€æ¯æ—¶æ¸…ç†
   */
  aboutToDisappear(): void {
    this.discoveryManager.removeDeviceStatusCallback(this.handleDeviceListChange);
  }
}