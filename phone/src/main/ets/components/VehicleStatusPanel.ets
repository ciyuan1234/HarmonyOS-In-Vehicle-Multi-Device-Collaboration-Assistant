/**
 * è½¦è¾†çŠ¶æ€é¢æ¿ç»„ä»¶
 * 
 * åŠŸèƒ½æè¿°ï¼š
 * 1. å®æ—¶æ˜¾ç¤ºè½¦æœºç«¯åŒæ­¥çš„è½¦è¾†çŠ¶æ€
 * 2. æ²¹é‡ã€èƒå‹ã€è½¦é€Ÿç­‰æ ¸å¿ƒæ•°æ®å±•ç¤º
 * 3. 1ç§’åˆ·æ–°é¢‘ç‡æ›´æ–°æ•°æ®
 * 
 * @author è½¦è½½å¤šè®¾å¤‡ååŒåŠ©æ‰‹é¡¹ç›®ç»„
 */

import { DistributedDataManager } from '../../../shared/src/main/ets/utils/DistributedDataManager';
import { hilog } from '@kit.PerformanceAnalysisKit';

@Component
export struct VehicleStatusPanel {
  // è½¦è¾†çŠ¶æ€æ•°æ®
  @State fuelLevel: number = 85;        // æ²¹é‡ç™¾åˆ†æ¯”
  @State tirePressure: number = 2.35;   // èƒå‹ bar
  @State speed: number = 60;            // è½¦é€Ÿ km/h
  @State lastUpdateTime: number = Date.now(); // æœ€åæ›´æ–°æ—¶é—´
  
  private dataManager: DistributedDataManager = DistributedDataManager.getInstance();
  private refreshTimer: number | null = null;
  private readonly TAG: string = 'VehicleStatusPanel';
  private readonly REFRESH_INTERVAL: number = 1000; // 1ç§’åˆ·æ–°
  
  aboutToAppear(): void {
    this.startDataRefresh();
  }
  
  aboutToDisappear(): void {
    this.stopDataRefresh();
  }
  
  build() {
    Column() {
      // é¢æ¿æ ‡é¢˜å’Œåˆ·æ–°çŠ¶æ€
      this.renderHeader()
      
      // æ ¸å¿ƒçŠ¶æ€æŒ‡æ ‡
      this.renderStatusIndicators()
      
      // è¯¦ç»†æ•°æ®å±•ç¤º
      this.renderDetailedData()
    }
    .width('100%')
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
    .padding(16)
    .shadow({ radius: 6, color: '#00000010', offsetX: 0, offsetY: 2 })
  }
  
  /**
   * æ¸²æŸ“é¢æ¿å¤´éƒ¨
   */
  @Builder
  private renderHeader() {
    Row() {
      Column() {
        Text('ğŸ“Š è½¦è¾†çŠ¶æ€')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')
        
        Text(`æ›´æ–°æ—¶é—´: ${new Date(this.lastUpdateTime).toLocaleTimeString()}`)
          .fontSize(10)
          .fontColor('#999999')
          .margin({ top: 2 })
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)
      
      // åˆ·æ–°æŒ‡ç¤ºå™¨
      LoadingProgress()
        .width(16)
        .height(16)
        .color('#2196F3')
    }
    .width('100%')
    .margin({ bottom: 16 })
  }
  
  /**
   * æ¸²æŸ“çŠ¶æ€æŒ‡æ ‡
   */
  @Builder
  private renderStatusIndicators() {
    Row() {
      // æ²¹é‡æŒ‡ç¤ºå™¨
      Column() {
        Stack() {
          // èƒŒæ™¯åœ†ç¯
          Circle()
            .width(80)
            .height(80)
            .strokeWidth(8)
            .stroke('#E0E0E0')
            .fill('#FFFFFF')
          
          // è¿›åº¦åœ†ç¯
          Circle()
            .width(80)
            .height(80)
            .strokeWidth(8)
            .stroke(this.getFuelColor())
            .fill('#FFFFFF')
            .strokeDashArray([Math.PI * 80 * (this.fuelLevel / 100), Math.PI * 80])
          
          // æ²¹é‡æ–‡æœ¬
          Column() {
            Text(`${this.fuelLevel}`)
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor(this.getFuelColor())
            
            Text('%')
              .fontSize(10)
              .fontColor('#999999')
          }
        }
        .width(90)
        .height(90)
        
        Text('æ²¹é‡')
          .fontSize(12)
          .fontColor('#666666')
          .margin({ top: 8 })
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Center)
      
      // èƒå‹æŒ‡ç¤ºå™¨
      Column() {
        Stack() {
          // èƒŒæ™¯åœ†ç¯
          Circle()
            .width(80)
            .height(80)
            .strokeWidth(8)
            .stroke('#E0E0E0')
            .fill('#FFFFFF')
          
          // è¿›åº¦åœ†ç¯
          Circle()
            .width(80)
            .height(80)
            .strokeWidth(8)
            .stroke(this.getTirePressureColor())
            .fill('#FFFFFF')
            .strokeDashArray([
              Math.PI * 80 * ((this.tirePressure - 2.0) / 1.0), 
              Math.PI * 80
            ])
          
          // èƒå‹æ–‡æœ¬
          Column() {
            Text(`${this.tirePressure.toFixed(2)}`)
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor(this.getTirePressureColor())
            
            Text('bar')
              .fontSize(10)
              .fontColor('#999999')
          }
        }
        .width(90)
        .height(90)
        
        Text('èƒå‹')
          .fontSize(12)
          .fontColor('#666666')
          .margin({ top: 8 })
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Center)
      
      // è½¦é€ŸæŒ‡ç¤ºå™¨
      Column() {
        Stack() {
          // èƒŒæ™¯åœ†ç¯
          Circle()
            .width(80)
            .height(80)
            .strokeWidth(8)
            .stroke('#E0E0E0')
            .fill('#FFFFFF')
          
          // è¿›åº¦åœ†ç¯
          Circle()
            .width(80)
            .height(80)
            .strokeWidth(8)
            .stroke(this.getSpeedColor())
            .fill('#FFFFFF')
            .strokeDashArray([Math.PI * 80 * (this.speed / 120), Math.PI * 80])
          
          // è½¦é€Ÿæ–‡æœ¬
          Column() {
            Text(`${this.speed}`)
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor(this.getSpeedColor())
            
            Text('km/h')
              .fontSize(10)
              .fontColor('#999999')
          }
        }
        .width(90)
        .height(90)
        
        Text('è½¦é€Ÿ')
          .fontSize(12)
          .fontColor('#666666')
          .margin({ top: 8 })
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Center)
    }
    .width('100%')
    .margin({ bottom: 20 })
  }
  
  /**
   * æ¸²æŸ“è¯¦ç»†æ•°æ®
   */
  @Builder
  private renderDetailedData() {
    Column() {
      Text('è¯¦ç»†ä¿¡æ¯')
        .fontSize(14)
        .fontWeight(FontWeight.Medium)
        .fontColor('#333333')
        .width('100%')
        .margin({ bottom: 12 })
        .selfAlign(ItemAlign.Start)
      
      // æ•°æ®è¡Œ
      Column() {
        this.renderDataItem('æ²¹é‡çŠ¶æ€', this.getFuelStatusText(), this.getFuelColor())
        this.renderDataItem('èƒå‹çŠ¶æ€', this.getTirePressureStatus(), this.getTirePressureColor())
        this.renderDataItem('è¡Œé©¶çŠ¶æ€', this.getSpeedStatusText(), this.getSpeedColor())
        this.renderDataItem('æ•°æ®å»¶è¿Ÿ', this.getDataDelayText(), '#666666')
      }
      .width('100%')
    }
    .width('100%')
  }
  
  /**
   * æ¸²æŸ“æ•°æ®é¡¹
   */
  @Builder
  private renderDataItem(label: string, value: string, color: string) {
    Row() {
      Text(label)
        .fontSize(12)
        .fontColor('#666666')
        .layoutWeight(1)
      
      Text(value)
        .fontSize(12)
        .fontColor(color)
        .fontWeight(FontWeight.Medium)
    }
    .width('100%')
    .padding({ vertical: 6 })
  }
  
  /**
   * å¼€å§‹æ•°æ®åˆ·æ–°
   */
  private startDataRefresh(): void {
    // æ³¨å†Œæ•°æ®å˜æ›´ç›‘å¬
    this.dataManager.onDataChanged(this.handleDataUpdate);
    
    // å¯åŠ¨å®šæ—¶åˆ·æ–°
    this.refreshTimer = setInterval(() => {
      this.refreshVehicleData();
    }, this.REFRESH_INTERVAL);
    
    // ç«‹å³è·å–ä¸€æ¬¡æ•°æ®
    this.refreshVehicleData();
    
    hilog.info(0x0000, this.TAG, 'Vehicle data refresh started');
  }
  
  /**
   * åœæ­¢æ•°æ®åˆ·æ–°
   */
  private stopDataRefresh(): void {
    // ç§»é™¤æ•°æ®ç›‘å¬
    this.dataManager.removeDataListener(this.handleDataUpdate);
    
    // åœæ­¢å®šæ—¶å™¨
    if (this.refreshTimer) {
      clearInterval(this.refreshTimer);
      this.refreshTimer = null;
    }
    
    hilog.info(0x0000, this.TAG, 'Vehicle data refresh stopped');
  }
  
  /**
   * åˆ·æ–°è½¦è¾†æ•°æ®
   */
  private async refreshVehicleData(): Promise<void> {
    try {
      const data = await this.dataManager.readVehicleData();
      
      this.fuelLevel = data.fuelLevel || 85;
      this.tirePressure = data.tirePressure || 2.35;
      this.speed = data.speed || 60;
      this.lastUpdateTime = data.lastUpdateTime || Date.now();
      
      hilog.debug(0x0000, this.TAG, 'Vehicle data refreshed: fuel=%{public}d%%, speed=%{public}d', 
                 this.fuelLevel, this.speed);
    } catch (error) {
      hilog.error(0x0000, this.TAG, 'Failed to refresh vehicle data: %{public}s', 
                 JSON.stringify(error));
    }
  }
  
  /**
   * å¤„ç†æ•°æ®æ›´æ–°
   */
  private handleDataUpdate = (data: any): void => {
    this.fuelLevel = data.fuelLevel !== undefined ? data.fuelLevel : this.fuelLevel;
    this.tirePressure = data.tirePressure !== undefined ? data.tirePressure : this.tirePressure;
    this.speed = data.speed !== undefined ? data.speed : this.speed;
    this.lastUpdateTime = data.lastUpdateTime || Date.now();
    
    hilog.debug(0x0000, this.TAG, 'Vehicle data updated from remote');
  }
  
  /**
   * è·å–æ²¹é‡é¢œè‰²
   */
  private getFuelColor(): string {
    if (this.fuelLevel > 50) return '#4CAF50';  // ç»¿è‰² - å……è¶³
    if (this.fuelLevel > 20) return '#FFC107';  // é»„è‰² - ä¸€èˆ¬
    return '#F44336';                           // çº¢è‰² - ä¸è¶³
  }
  
  /**
   * è·å–æ²¹é‡çŠ¶æ€æ–‡å­—
   */
  private getFuelStatusText(): string {
    if (this.fuelLevel > 50) return 'å……è¶³';
    if (this.fuelLevel > 20) return 'ä¸€èˆ¬';
    return 'ä¸è¶³';
  }
  
  /**
   * è·å–èƒå‹é¢œè‰²
   */
  private getTirePressureColor(): string {
    if (this.tirePressure >= 2.2 && this.tirePressure <= 2.5) return '#4CAF50'; // æ­£å¸¸
    if (this.tirePressure >= 2.0 && this.tirePressure <= 2.7) return '#FFC107'; // è­¦å‘Š
    return '#F44336';                                                           // å±é™©
  }
  
  /**
   * è·å–èƒå‹çŠ¶æ€æ–‡å­—
   */
  private getTirePressureStatus(): string {
    if (this.tirePressure >= 2.2 && this.tirePressure <= 2.5) return 'æ­£å¸¸';
    if (this.tirePressure < 2.2) return 'åä½';
    return 'åé«˜';
  }
  
  /**
   * è·å–è½¦é€Ÿé¢œè‰²
   */
  private getSpeedColor(): string {
    if (this.speed < 60) return '#4CAF50';   // ç»¿è‰² - ä½é€Ÿ
    if (this.speed < 100) return '#FFC107';  // é»„è‰² - ä¸­é€Ÿ
    return '#F44336';                        // çº¢è‰² - é«˜é€Ÿ
  }
  
  /**
   * è·å–è½¦é€ŸçŠ¶æ€æ–‡å­—
   */
  private getSpeedStatusText(): string {
    if (this.speed === 0) return 'é™æ­¢';
    if (this.speed < 60) return 'ä½é€Ÿè¡Œé©¶';
    if (this.speed < 100) return 'ä¸­é€Ÿè¡Œé©¶';
    return 'é«˜é€Ÿè¡Œé©¶';
  }
  
  /**
   * è·å–æ•°æ®å»¶è¿Ÿæ–‡å­—
   */
  private getDataDelayText(): string {
    const delay = Date.now() - this.lastUpdateTime;
    if (delay < 2000) return 'å®æ—¶';
    if (delay < 5000) return 'ç¨æœ‰å»¶è¿Ÿ';
    return 'å»¶è¿Ÿè¾ƒå¤§';
  }
}