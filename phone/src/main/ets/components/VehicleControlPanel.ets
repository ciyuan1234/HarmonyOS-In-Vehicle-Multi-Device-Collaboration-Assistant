import { VehicleStatus, ControlCommand } from '../../../../shared/src/main/ets/model/DeviceModel';
import { formatSpeed, formatFuelLevel, formatTemperature } from '../../../../shared/src/main/ets/utils/CommonUtils';

/**
 * è½¦è¾†æ§åˆ¶é¢æ¿ç»„ä»¶
 */
@Component
export struct VehicleControlPanel {
  @State vehicleStatus: VehicleStatus = {
    speed: 0,
    engineStatus: false,
    fuelLevel: 80,
    temperature: 22,
    doorLocked: true,
    latitude: 39.9042,
    longitude: 116.4074,
    updateTime: Date.now()
  };
  
  @Prop onSendCommand?: (command: ControlCommand, params?: any) => void;

  build() {
    Column() {
      // è½¦è¾†çŠ¶æ€æ¦‚è§ˆ
      this.renderStatusOverview()
      
      // æ§åˆ¶æŒ‰é’®åŒºåŸŸ
      this.renderControlButtons()
      
      // è¯¦ç»†ä¿¡æ¯åŒºåŸŸ
      this.renderDetailedInfo()
    }
    .width('100%')
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
    .padding(16)
    .shadow({ radius: 6, color: '#00000010', offsetX: 0, offsetY: 2 })
  }

  /**
   * æ¸²æŸ“çŠ¶æ€æ¦‚è§ˆ
   */
  @Builder
  renderStatusOverview() {
    Row() {
      // è½¦è¾†å›¾æ ‡å’ŒåŸºæœ¬ä¿¡æ¯
      Column() {
        Text('ğŸš—')
          .fontSize(32)
        
        Text('æˆ‘çš„çˆ±è½¦')
          .fontSize(14)
          .fontColor('#666666')
          .margin({ top: 4 })
      }
      .alignItems(HorizontalAlign.Center)
      .margin({ right: 16 })
      
      // çŠ¶æ€æŒ‡æ ‡
      Column() {
        Row() {
          this.renderStatusIndicator('è½¦é€Ÿ', formatSpeed(this.vehicleStatus.speed), '#2196F3')
          this.renderStatusIndicator('ç‡ƒæ²¹', formatFuelLevel(this.vehicleStatus.fuelLevel), '#FF9800')
        }
        .justifyContent(FlexAlign.SpaceBetween)
        .width('100%')
        .margin({ bottom: 8 })
        
        Row() {
          this.renderStatusIndicator('æ¸©åº¦', formatTemperature(this.vehicleStatus.temperature), '#4CAF50')
          this.renderStatusIndicator('çŠ¶æ€', this.vehicleStatus.engineStatus ? 'è¿è¡Œä¸­' : 'å·²ç†„ç«', 
            this.vehicleStatus.engineStatus ? '#F44336' : '#9E9E9E')
        }
        .justifyContent(FlexAlign.SpaceBetween)
        .width('100%')
      }
      .layoutWeight(1)
    }
    .width('100%')
    .margin({ bottom: 20 })
  }

  /**
   * æ¸²æŸ“çŠ¶æ€æŒ‡æ ‡
   */
  @Builder
  renderStatusIndicator(label: string, value: string, color: string) {
    Column() {
      Text(value)
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor(color)
      
      Text(label)
        .fontSize(12)
        .fontColor('#999999')
        .margin({ top: 2 })
    }
    .alignItems(HorizontalAlign.Center)
  }

  /**
   * æ¸²æŸ“æ§åˆ¶æŒ‰é’®åŒºåŸŸ
   */
  @Builder
  renderControlButtons() {
    Grid() {
      // å¯åŠ¨/åœæ­¢å‘åŠ¨æœº
      GridItem() {
        this.renderControlButton(
          this.vehicleStatus.engineStatus ? 'â¹ï¸' : 'â–¶ï¸',
          this.vehicleStatus.engineStatus ? 'åœæ­¢' : 'å¯åŠ¨',
          this.vehicleStatus.engineStatus ? '#F44336' : '#4CAF50',
          () => this.handleEngineToggle()
        )
      }
      
      // é”è½¦/è§£é”
      GridItem() {
        this.renderControlButton(
          this.vehicleStatus.doorLocked ? 'ğŸ”“' : 'ğŸ”’',
          this.vehicleStatus.doorLocked ? 'è§£é”' : 'é”è½¦',
          this.vehicleStatus.doorLocked ? '#4CAF50' : '#FF9800',
          () => this.handleDoorToggle()
        )
      }
      
      // ç©ºè°ƒæ§åˆ¶
      GridItem() {
        this.renderControlButton(
          'â„ï¸',
          'ç©ºè°ƒ',
          '#2196F3',
          () => this.handleAcControl()
        )
      }
      
      // å¯¼èˆª
      GridItem() {
        this.renderControlButton(
          'ğŸ§­',
          'å¯¼èˆª',
          '#9C27B0',
          () => this.handleNavigation()
        )
      }
    }
    .columnsTemplate('1fr 1fr')
    .rowsTemplate('1fr 1fr')
    .columnsGap(12)
    .rowsGap(12)
    .margin({ bottom: 20 })
  }

  /**
   * æ¸²æŸ“æ§åˆ¶æŒ‰é’®
   */
  @Builder
  renderControlButton(icon: string, label: string, bgColor: string, onClick: () => void) {
    Column() {
      Text(icon)
        .fontSize(24)
      
      Text(label)
        .fontSize(12)
        .fontColor('#333333')
        .margin({ top: 4 })
    }
    .width('100%')
    .height(80)
    .backgroundColor(bgColor)
    .borderRadius(8)
    .justifyContent(FlexAlign.Center)
    .onClick(() => {
      if (onClick) onClick();
    })
  }

  /**
   * æ¸²æŸ“è¯¦ç»†ä¿¡æ¯
   */
  @Builder
  renderDetailedInfo() {
    Column() {
      Text('è¯¦ç»†ä¿¡æ¯')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor('#333333')
        .margin({ bottom: 12 })
      
      // ä½ç½®ä¿¡æ¯
      Row() {
        Text('ğŸ“ ä½ç½®:')
          .fontSize(14)
          .fontColor('#666666')
          .layoutWeight(1)
        
        Text(`${this.vehicleStatus.latitude.toFixed(6)}, ${this.vehicleStatus.longitude.toFixed(6)}`)
          .fontSize(14)
          .fontColor('#333333')
      }
      .width('100%')
      .margin({ bottom: 8 })
      
      // æ›´æ–°æ—¶é—´
      Row() {
        Text('ğŸ•’ æ›´æ–°æ—¶é—´:')
          .fontSize(14)
          .fontColor('#666666')
          .layoutWeight(1)
        
        Text(new Date(this.vehicleStatus.updateTime).toLocaleTimeString())
          .fontSize(14)
          .fontColor('#333333')
      }
      .width('100%')
    }
    .width('100%')
  }

  /**
   * å¤„ç†å‘åŠ¨æœºå¼€å…³
   */
  private handleEngineToggle(): void {
    const command = this.vehicleStatus.engineStatus ? 
      ControlCommand.STOP_ENGINE : ControlCommand.START_ENGINE;
    if (this.onSendCommand) {
      this.onSendCommand(command);
    }
  }

  /**
   * å¤„ç†è½¦é—¨é”æ§åˆ¶
   */
  private handleDoorToggle(): void {
    const command = this.vehicleStatus.doorLocked ? 
      ControlCommand.UNLOCK_DOOR : ControlCommand.LOCK_DOOR;
    if (this.onSendCommand) {
      this.onSendCommand(command);
    }
  }

  /**
   * å¤„ç†ç©ºè°ƒæ§åˆ¶
   */
  private handleAcControl(): void {
    // è¿™é‡Œå¯ä»¥æ‰“å¼€ç©ºè°ƒè®¾ç½®å¼¹çª—
    if (this.onSendCommand) {
      this.onSendCommand(ControlCommand.OPEN_AC);
    }
  }

  /**
   * å¤„ç†å¯¼èˆª
   */
  private handleNavigation(): void {
    // è¿™é‡Œå¯ä»¥æ‰“å¼€å¯¼èˆªè®¾ç½®
    if (this.onSendCommand) {
      this.onSendCommand(ControlCommand.NAVIGATE_TO, {
        destination: 'å…¬å¸'
      });
    }
  }

  /**
   * æ›´æ–°è½¦è¾†çŠ¶æ€
   */
  updateStatus(status: VehicleStatus): void {
    this.vehicleStatus = { ...status };
  }
}