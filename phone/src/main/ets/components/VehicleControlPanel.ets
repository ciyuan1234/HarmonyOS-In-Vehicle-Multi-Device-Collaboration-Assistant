/**
 * è½¦è¾†æ§åˆ¶é¢æ¿ç»„ä»¶
 * 
 * åŠŸèƒ½æè¿°ï¼š
 * 1. å¯¼èˆªæ§åˆ¶ï¼šè®¾ç½®ç›®çš„åœ°å¹¶ä¸‹å‘åˆ°è½¦æœº
 * 2. éŸ³ä¹æ§åˆ¶ï¼šæ’­æ”¾/æš‚åœ/åˆ‡æ­Œ
 * 3. ç©ºè°ƒæ§åˆ¶ï¼šæ¸©åº¦è°ƒèŠ‚
 * 
 * @author è½¦è½½å¤šè®¾å¤‡ååŒåŠ©æ‰‹é¡¹ç›®ç»„
 */

import { DistributedDataManager } from '../../../shared/src/main/ets/utils/DistributedDataManager';
import { hilog } from '@kit.PerformanceAnalysisKit';
import { promptAction } from '@kit.ArkUI';

@Component
export struct VehicleControlPanel {
  // å¯¼èˆªæ§åˆ¶çŠ¶æ€
  @State destination: string = '';
  @State isNavigating: boolean = false;
  
  // éŸ³ä¹æ§åˆ¶çŠ¶æ€
  @State isMusicPlaying: boolean = false;
  @State currentSong: string = 'æœªé€‰æ‹©æ­Œæ›²';
  
  // ç©ºè°ƒæ§åˆ¶çŠ¶æ€
  @State acTemperature: number = 22;
  @State isAcOn: boolean = false;
  
  private dataManager: DistributedDataManager = DistributedDataManager.getInstance();
  private readonly TAG: string = 'VehicleControlPanel';
  
  build() {
    Column() {
      // é¢æ¿æ ‡é¢˜
      Text('ğŸš— è½¦è¾†æ§åˆ¶')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')
        .width('100%')
        .margin({ bottom: 16 })
        .selfAlign(ItemAlign.Start)
      
      // å¯¼èˆªæ§åˆ¶åŒºåŸŸ
      this.renderNavigationControl()
      
      // éŸ³ä¹æ§åˆ¶åŒºåŸŸ
      this.renderMusicControl()
      
      // ç©ºè°ƒæ§åˆ¶åŒºåŸŸ
      this.renderClimateControl()
    }
    .width('100%')
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
    .padding(16)
    .shadow({ radius: 6, color: '#00000010', offsetX: 0, offsetY: 2 })
  }
  
  /**
   * æ¸²æŸ“å¯¼èˆªæ§åˆ¶
   */
  @Builder
  private renderNavigationControl() {
    Column() {
      Row() {
        Text('ğŸ§­ å¯¼èˆªæ§åˆ¶')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
          .layoutWeight(1)
        
        If (this.isNavigating) {
          Text('å¯¼èˆªä¸­')
            .fontSize(12)
            .fontColor('#4CAF50')
        }
      }
      .width('100%')
      .margin({ bottom: 12 })
      
      // ç›®çš„åœ°è¾“å…¥
      Row() {
        TextInput({ placeholder: 'è¯·è¾“å…¥ç›®çš„åœ°', text: this.destination })
          .layoutWeight(1)
          .height(40)
          .borderRadius(8)
          .margin({ right: 8 })
          .onChange((value: string) => {
            this.destination = value;
          })
        
        Button('ä¸‹å‘')
          .width(60)
          .height(40)
          .backgroundColor('#2196F3')
          .fontColor('#FFFFFF')
          .borderRadius(8)
          .enabled(this.destination.length > 0 && !this.isNavigating)
          .onClick(() => {
            this.sendNavigationCommand();
          })
      }
      .width('100%')
      .margin({ bottom: 8 })
      
      // å¯¼èˆªçŠ¶æ€æŒ‰é’®
      Row() {
        Button(this.isNavigating ? 'ç»“æŸå¯¼èˆª' : 'å¼€å§‹å¯¼èˆª')
          .layoutWeight(1)
          .height(36)
          .backgroundColor(this.isNavigating ? '#F44336' : '#4CAF50')
          .fontColor('#FFFFFF')
          .borderRadius(8)
          .margin({ right: 8 })
          .onClick(() => {
            this.toggleNavigation();
          })
        
        Button('æ¨¡æ‹Ÿè·¯çº¿')
          .layoutWeight(1)
          .height(36)
          .backgroundColor('#FF9800')
          .fontColor('#FFFFFF')
          .borderRadius(8)
          .onClick(() => {
            this.simulateRoute();
          })
      }
      .width('100%')
    }
    .width('100%')
    .margin({ bottom: 20 })
  }
  
  /**
   * æ¸²æŸ“éŸ³ä¹æ§åˆ¶
   */
  @Builder
  private renderMusicControl() {
    Column() {
      Row() {
        Text('ğŸµ éŸ³ä¹æ§åˆ¶')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
          .layoutWeight(1)
        
        If (this.isMusicPlaying) {
          Text('æ’­æ”¾ä¸­')
            .fontSize(12)
            .fontColor('#4CAF50')
        }
      }
      .width('100%')
      .margin({ bottom: 12 })
      
      // å½“å‰æ­Œæ›²æ˜¾ç¤º
      Text(this.currentSong)
        .fontSize(14)
        .fontColor('#666666')
        .width('100%')
        .textAlign(TextAlign.Center)
        .margin({ bottom: 12 })
        .maxLines(1)
        .textOverflow({ overflow: TextOverflow.Ellipsis })
      
      // æ§åˆ¶æŒ‰é’®
      Row() {
        Button('â®')
          .width(45)
          .height(45)
          .backgroundColor('#F5F5F5')
          .fontColor('#333333')
          .borderRadius(22)
          .margin({ right: 12 })
          .onClick(() => {
            this.previousSong();
          })
        
        Button(this.isMusicPlaying ? 'â¸' : 'â–¶')
          .width(55)
          .height(55)
          .backgroundColor('#2196F3')
          .fontColor('#FFFFFF')
          .borderRadius(27)
          .margin({ left: 12, right: 12 })
          .onClick(() => {
            this.toggleMusic();
          })
        
        Button('â­')
          .width(45)
          .height(45)
          .backgroundColor('#F5F5F5')
          .fontColor('#333333')
          .borderRadius(22)
          .margin({ left: 12 })
          .onClick(() => {
            this.nextSong();
          })
      }
      .width('100%')
      .justifyContent(FlexAlign.Center)
      .margin({ bottom: 8 })
      
      // éŸ³é‡æ§åˆ¶
      Row() {
        Text('ğŸ”ˆ')
          .fontSize(16)
          .margin({ right: 8 })
        
        Slider({
          value: 70,
          min: 0,
          max: 100,
          style: SliderStyle.OutSet
        })
        .layoutWeight(1)
        .onChange((value: number) => {
          this.adjustVolume(Math.round(value));
        })
      }
      .width('100%')
      .alignItems(VerticalAlign.Center)
    }
    .width('100%')
    .margin({ bottom: 20 })
  }
  
  /**
   * æ¸²æŸ“ç©ºè°ƒæ§åˆ¶
   */
  @Builder
  private renderClimateControl() {
    Column() {
      Row() {
        Text('â„ï¸ ç©ºè°ƒæ§åˆ¶')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
          .layoutWeight(1)
        
        Toggle({ type: ToggleType.Switch, isOn: this.isAcOn })
          .onChange((isOn: boolean) => {
            this.toggleAc(isOn);
          })
      }
      .width('100%')
      .margin({ bottom: 12 })
      
      // æ¸©åº¦æ˜¾ç¤ºå’Œè°ƒèŠ‚
      Column() {
        Text(`${this.acTemperature}Â°C`)
          .fontSize(28)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.isAcOn ? '#2196F3' : '#999999')
          .margin({ bottom: 8 })
        
        Text('å½“å‰æ¸©åº¦è®¾å®š')
          .fontSize(12)
          .fontColor('#666666')
          .margin({ bottom: 16 })
        
        // æ¸©åº¦è°ƒèŠ‚æ»‘å—
        Slider({
          value: this.acTemperature,
          min: 18,
          max: 30,
          style: SliderStyle.OutSet
        })
        .width('100%')
        .enabled(this.isAcOn)
        .onChange((value: number) => {
          this.setAcTemperature(Math.round(value));
        })
        .margin({ bottom: 12 })
        
        // æ¸©åº¦é¢„è®¾æŒ‰é’®
        Row() {
          ForEach([18, 22, 25, 28], (temp: number) => {
            Button(`${temp}Â°`)
              .width(50)
              .height(30)
              .fontSize(12)
              .backgroundColor(this.acTemperature === temp ? '#2196F3' : '#F5F5F5')
              .fontColor(this.acTemperature === temp ? '#FFFFFF' : '#333333')
              .borderRadius(6)
              .margin({ right: 8 })
              .onClick(() => {
                this.setAcTemperature(temp);
              })
          })
        }
        .width('100%')
        .justifyContent(FlexAlign.Center)
      }
      .width('100%')
    }
    .width('100%')
  }
  
  /**
   * å‘é€å¯¼èˆªæŒ‡ä»¤
   */
  private async sendNavigationCommand(): Promise<void> {
    if (!this.destination) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥ç›®çš„åœ°' });
      return;
    }
    
    try {
      const success = await this.dataManager.storeVehicleData({
        navigationDestination: this.destination
      });
      
      if (success) {
        promptAction.showToast({ message: 'å¯¼èˆªæŒ‡ä»¤å·²å‘é€åˆ°è½¦æœº' });
        hilog.info(0x0000, this.TAG, 'Navigation command sent: %{public}s', this.destination);
      } else {
        promptAction.showToast({ message: 'æŒ‡ä»¤å‘é€å¤±è´¥' });
      }
    } catch (error) {
      hilog.error(0x0000, this.TAG, 'Failed to send navigation command: %{public}s', 
                 JSON.stringify(error));
      promptAction.showToast({ message: 'å‘é€å¤±è´¥' });
    }
  }
  
  /**
   * åˆ‡æ¢å¯¼èˆªçŠ¶æ€
   */
  private toggleNavigation(): void {
    this.isNavigating = !this.isNavigating;
    const message = this.isNavigating ? 'å¯¼èˆªå·²å¼€å§‹' : 'å¯¼èˆªå·²ç»“æŸ';
    promptAction.showToast({ message: message });
    hilog.info(0x0000, this.TAG, 'Navigation toggled: %{public}s', this.isNavigating.toString());
  }
  
  /**
   * æ¨¡æ‹Ÿè·¯çº¿
   */
  private simulateRoute(): void {
    if (!this.destination) {
      promptAction.showToast({ message: 'è¯·å…ˆè®¾ç½®ç›®çš„åœ°' });
      return;
    }
    
    promptAction.showDialog({
      title: 'æ¨¡æ‹Ÿè·¯çº¿',
      message: `ä»å½“å‰ä½ç½®åˆ°${this.destination}çš„è·¯çº¿ï¼š\n1. ç›´è¡Œ2å…¬é‡Œ\n2. å³è½¬è¿›å…¥ä¸»å¹²é“\n3. è¡Œé©¶8å…¬é‡Œåˆ°è¾¾`,
      buttons: [
        {
          text: 'ç¡®å®š',
          color: '#2196F3'
        }
      ]
    });
  }
  
  /**
   * åˆ‡æ¢éŸ³ä¹æ’­æ”¾çŠ¶æ€
   */
  private async toggleMusic(): Promise<void> {
    this.isMusicPlaying = !this.isMusicPlaying;
    
    try {
      await this.dataManager.storeVehicleData({
        isMusicPlaying: this.isMusicPlaying
      });
      
      const message = this.isMusicPlaying ? 'éŸ³ä¹å·²å¼€å§‹æ’­æ”¾' : 'éŸ³ä¹å·²æš‚åœ';
      promptAction.showToast({ message: message });
      hilog.info(0x0000, this.TAG, 'Music toggled: %{public}s', this.isMusicPlaying.toString());
    } catch (error) {
      hilog.error(0x0000, this.TAG, 'Failed to toggle music: %{public}s', JSON.stringify(error));
    }
  }
  
  /**
   * ä¸Šä¸€é¦–æ­Œæ›²
   */
  private previousSong(): void {
    this.currentSong = 'ä¸Šä¸€é¦–æ­Œæ›²';
    promptAction.showToast({ message: 'åˆ‡æ¢åˆ°ä¸Šä¸€é¦–' });
    hilog.info(0x0000, this.TAG, 'Previous song selected');
  }
  
  /**
   * ä¸‹ä¸€é¦–æ­Œæ›²
   */
  private nextSong(): void {
    this.currentSong = 'ä¸‹ä¸€é¦–æ­Œæ›²';
    promptAction.showToast({ message: 'åˆ‡æ¢åˆ°ä¸‹ä¸€é¦–' });
    hilog.info(0x0000, this.TAG, 'Next song selected');
  }
  
  /**
   * è°ƒèŠ‚éŸ³é‡
   */
  private adjustVolume(volume: number): void {
    hilog.info(0x0000, this.TAG, 'Volume adjusted to: %{public}d%%', volume);
  }
  
  /**
   * åˆ‡æ¢ç©ºè°ƒå¼€å…³
   */
  private async toggleAc(isOn: boolean): Promise<void> {
    this.isAcOn = isOn;
    
    try {
      await this.dataManager.storeVehicleData({
        isAcOn: isOn
      });
      
      const message = isOn ? 'ç©ºè°ƒå·²å¼€å¯' : 'ç©ºè°ƒå·²å…³é—­';
      promptAction.showToast({ message: message });
      hilog.info(0x0000, this.TAG, 'AC toggled: %{public}s', isOn.toString());
    } catch (error) {
      hilog.error(0x0000, this.TAG, 'Failed to toggle AC: %{public}s', JSON.stringify(error));
    }
  }
  
  /**
   * è®¾ç½®ç©ºè°ƒæ¸©åº¦
   */
  private async setAcTemperature(temperature: number): Promise<void> {
    this.acTemperature = temperature;
    
    if (this.isAcOn) {
      try {
        await this.dataManager.storeVehicleData({
          acTemperature: temperature
        });
        
        hilog.info(0x0000, this.TAG, 'AC temperature set to: %{public}dÂ°C', temperature);
      } catch (error) {
        hilog.error(0x0000, this.TAG, 'Failed to set AC temperature: %{public}s', 
                   JSON.stringify(error));
      }
    }
  }
}