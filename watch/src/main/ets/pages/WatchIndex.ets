/**
 * æ‰‹è¡¨ç«¯ä¸»é¡µ - è½¦è½½å¤šè®¾å¤‡ååŒåŠ©æ‰‹
 * 
 * æ ¸å¿ƒåŠŸèƒ½ï¼š
 * 1. è¿æ¥è½¦æœºæ¨¡æ‹Ÿå™¨ï¼ŒåŒæ­¥è½¦è¾†çŠ¶æ€æ•°æ®ï¼ˆæ²¹é‡ã€èƒå‹ã€ç»­èˆªé‡Œç¨‹ï¼‰
 * 2. å¿«æ·æ“ä½œï¼šä¸€é”®å¯»è½¦ã€ç©ºè°ƒæ§åˆ¶ã€è½¦é—¨æ§åˆ¶
 * 3. UIé€‚é…æ‰‹è¡¨å°å±ï¼šå¡ç‰‡å¼å¸ƒå±€ï¼Œå¤§æŒ‰é’®æ˜“ç‚¹å‡»ï¼Œæ•°æ®å±•ç¤ºç®€æ´
 * 
 * @author è½¦è½½å¤šè®¾å¤‡ååŒåŠ©æ‰‹é¡¹ç›®ç»„
 * @since 2024
 */

import { BusinessError } from '@kit.BasicServicesKit';
import { promptAction } from '@kit.ArkUI';
import { hilog } from '@kit.PerformanceAnalysisKit';
import { DistributedDataManager } from '../../../shared/src/main/ets/utils/DistributedDataManager';
import { DeviceDiscoveryManager } from '../../../shared/src/main/ets/utils/DeviceDiscoveryManager';

interface VehicleStatusData {
  fuelLevel: number;        // æ²¹é‡ç™¾åˆ†æ¯” (0-100)
  tirePressure: number;     // èƒå‹ (bar)
  mileage: number;          // ç»­èˆªé‡Œç¨‹ (km)
  speed: number;            // è½¦é€Ÿ (km/h)
  engineStatus: boolean;    // å‘åŠ¨æœºçŠ¶æ€
  acStatus: boolean;        // ç©ºè°ƒçŠ¶æ€
  doorLocked: boolean;      // è½¦é—¨é”å®šçŠ¶æ€
  updateTime: number;       // æ›´æ–°æ—¶é—´æˆ³
}

@Component
struct QuickActionButton {
  @Prop icon: string;
  @Prop label: string;
  @Prop backgroundColor: string;
  @Prop onPress: () => void;

  build() {
    Column() {
      // å›¾æ ‡
      Text(this.icon)
        .fontSize(28)
        .margin({ bottom: 4 })
      
      // æ ‡ç­¾
      Text(this.label)
        .fontSize(12)
        .fontColor('#FFFFFF')
        .fontWeight(FontWeight.Medium)
        .textAlign(TextAlign.Center)
        .maxLines(1)
    }
    .width(70)
    .height(70)
    .backgroundColor(this.backgroundColor)
    .borderRadius(35)
    .justifyContent(FlexAlign.Center)
    .onClick(this.onPress)
    .shadow({ radius: 6, color: '#00000040', offsetX: 0, offsetY: 3 })
    .transition({ type: TransitionType.All, duration: 200 })
  }
}

@Component
struct StatusCard {
  @Prop title: string;
  @Prop value: string;
  @Prop unit: string;
  @Prop icon: string;
  @Prop statusColor: string;

  build() {
    Column() {
      Row() {
        Text(this.icon)
          .fontSize(20)
          .margin({ right: 8 })
        
        Text(this.title)
          .fontSize(14)
          .fontColor('#FFFFFF')
          .fontWeight(FontWeight.Medium)
          .layoutWeight(1)
      }
      .width('100%')
      .margin({ bottom: 8 })
      
      Row() {
        Text(this.value)
          .fontSize(24)
          .fontColor(this.statusColor)
          .fontWeight(FontWeight.Bold)
        
        Text(this.unit)
          .fontSize(12)
          .fontColor('#AAAAAA')
          .margin({ left: 4 })
      }
      .alignItems(VerticalAlign.Bottom)
    }
    .width('100%')
    .backgroundColor('#1E1E1E')
    .borderRadius(12)
    .padding(12)
    .shadow({ radius: 4, color: '#00000030', offsetX: 0, offsetY: 2 })
  }
}

@Entry
@Component
struct WatchIndex {
  // çŠ¶æ€ç®¡ç†
  @State currentTime: string = '';
  @State currentDate: string = '';
  @State isConnected: boolean = false;
  @State isLoading: boolean = true;
  
  // è½¦è¾†çŠ¶æ€æ•°æ®
  @State vehicleStatus: VehicleStatusData = {
    fuelLevel: 0,
    tirePressure: 0,
    mileage: 0,
    speed: 0,
    engineStatus: false,
    acStatus: false,
    doorLocked: true,
    updateTime: 0
  };
  
  // å·¥å…·ç±»å®ä¾‹
  private dataManager: DistributedDataManager = DistributedDataManager.getInstance();
  private discoveryManager: DeviceDiscoveryManager = DeviceDiscoveryManager.getInstance();
  
  // å®šæ—¶å™¨
  private clockTimer: number = -1;
  private statusTimer: number = -1;
  
  // è®¾å¤‡ID
  private readonly DEVICE_ID: string = 'watch_device_' + Date.now().toString();
  private readonly TAG: string = 'WatchIndex';

  aboutToAppear(): void {
    this.initializeApp();
    this.startClock();
    this.startStatusUpdates();
  }

  aboutToDisappear(): void {
    this.cleanup();
  }

  build() {
    Column() {
      if (this.isLoading) {
        this.renderLoadingView();
      } else {
        // é¡¶éƒ¨çŠ¶æ€æ 
        this.renderStatusBar();
        
        // æ—¶é—´æ˜¾ç¤º
        this.renderTimeDisplay();
        
        // è½¦è¾†çŠ¶æ€å¡ç‰‡
        this.renderVehicleStatus();
        
        // å¿«æ·æ“ä½œæŒ‰é’®
        this.renderQuickActions();
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#000000')
    .padding({ left: 16, right: 16, top: 20, bottom: 16 })
  }

  /**
   * æ¸²æŸ“åŠ è½½è§†å›¾
   */
  @Builder
  renderLoadingView() {
    Column() {
      Text('âŒš')
        .fontSize(40)
        .margin({ bottom: 12 })
      
      Text('è½¦è½½åŠ©æ‰‹')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor('#FFFFFF')
        .margin({ bottom: 8 })
      
      Text('æ­£åœ¨è¿æ¥è½¦æœº...')
        .fontSize(12)
        .fontColor('#AAAAAA')
      
      LoadingProgress()
        .width(24)
        .height(24)
        .color('#2196F3')
        .margin({ top: 16 })
    }
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
  }

  /**
   * æ¸²æŸ“çŠ¶æ€æ 
   */
  @Builder
  renderStatusBar() {
    Row() {
      // è¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨
      Circle()
        .width(8)
        .height(8)
        .fill(this.isConnected ? '#4CAF50' : '#F44336')
        .margin({ right: 8 })
      
      Text(this.isConnected ? 'å·²è¿æ¥' : 'æœªè¿æ¥')
        .fontSize(12)
        .fontColor(this.isConnected ? '#4CAF50' : '#F44336')
        .layoutWeight(1)
      
      // åˆ·æ–°æŒ‰é’®
      Button('ğŸ”„')
        .width(28)
        .height(28)
        .fontSize(14)
        .backgroundColor('#333333')
        .fontColor('#FFFFFF')
        .borderRadius(14)
        .onClick(() => {
          this.refreshConnection();
        })
    }
    .width('100%')
    .margin({ bottom: 16 })
  }

  /**
   * æ¸²æŸ“æ—¶é—´æ˜¾ç¤º
   */
  @Builder
  renderTimeDisplay() {
    Column() {
      Text(this.currentTime)
        .fontSize(32)
        .fontWeight(FontWeight.Bold)
        .fontColor('#FFFFFF')
        .margin({ bottom: 4 })
      
      Text(this.currentDate)
        .fontSize(12)
        .fontColor('#AAAAAA')
    }
    .width('100%')
    .margin({ bottom: 20 })
    .alignItems(HorizontalAlign.Center)
  }

  /**
   * æ¸²æŸ“è½¦è¾†çŠ¶æ€å¡ç‰‡
   */
  @Builder
  renderVehicleStatus() {
    Column() {
      // ç¬¬ä¸€è¡Œï¼šæ²¹é‡å’Œèƒå‹
      Row() {
        StatusCard({
          title: 'æ²¹é‡',
          value: this.vehicleStatus.fuelLevel.toString(),
          unit: '%',
          icon: 'â›½',
          statusColor: this.getFuelColor()
        })
        .layoutWeight(1)
        .margin({ right: 8 })
        
        StatusCard({
          title: 'èƒå‹',
          value: this.vehicleStatus.tirePressure.toFixed(1),
          unit: 'bar',
          icon: 'ğŸ›',
          statusColor: this.getTirePressureColor()
        })
        .layoutWeight(1)
      }
      .width('100%')
      .margin({ bottom: 12 })
      
      // ç¬¬äºŒè¡Œï¼šç»­èˆªé‡Œç¨‹å’Œè½¦é€Ÿ
      Row() {
        StatusCard({
          title: 'ç»­èˆª',
          value: this.vehicleStatus.mileage.toString(),
          unit: 'km',
          icon: 'ğŸ”‹',
          statusColor: '#4CAF50'
        })
        .layoutWeight(1)
        .margin({ right: 8 })
        
        StatusCard({
          title: 'è½¦é€Ÿ',
          value: this.vehicleStatus.speed.toString(),
          unit: 'km/h',
          icon: 'ğŸš€',
          statusColor: this.getSpeedColor()
        })
        .layoutWeight(1)
      }
      .width('100%')
    }
    .width('100%')
    .margin({ bottom: 24 })
  }

  /**
   * æ¸²æŸ“å¿«æ·æ“ä½œæŒ‰é’®
   */
  @Builder
  renderQuickActions() {
    Grid() {
      // ä¸€é”®å¯»è½¦
      GridItem() {
        QuickActionButton({
          icon: 'ğŸ”',
          label: 'å¯»è½¦',
          backgroundColor: '#9C27B0',
          onPress: this.handleFindCar
        })
      }
      
      // ç©ºè°ƒæ§åˆ¶
      GridItem() {
        QuickActionButton({
          icon: this.vehicleStatus.acStatus ? 'â„ï¸' : 'ğŸ§Š',
          label: this.vehicleStatus.acStatus ? 'å…³é—­ç©ºè°ƒ' : 'å¼€å¯ç©ºè°ƒ',
          backgroundColor: this.vehicleStatus.acStatus ? '#2196F3' : '#607D8B',
          onPress: this.handleAcControl
        })
      }
      
      // è½¦é—¨æ§åˆ¶
      GridItem() {
        QuickActionButton({
          icon: this.vehicleStatus.doorLocked ? 'ğŸ”’' : 'ğŸ”“',
          label: this.vehicleStatus.doorLocked ? 'è§£é”' : 'ä¸Šé”',
          backgroundColor: this.vehicleStatus.doorLocked ? '#4CAF50' : '#FF9800',
          onPress: this.handleDoorControl
        })
      }
    }
    .columnsTemplate('1fr 1fr 1fr')
    .columnsGap(12)
    .rowsGap(12)
  }

  /**
   * åˆå§‹åŒ–åº”ç”¨ç¨‹åº
   */
  private async initializeApp(): Promise<void> {
    try {
      this.isLoading = true;
      
      // åˆå§‹åŒ–åˆ†å¸ƒå¼æ•°æ®ç®¡ç†å™¨
      const dataSuccess = await this.dataManager.init(this.DEVICE_ID);
      
      // åˆå§‹åŒ–è®¾å¤‡å‘ç°ç®¡ç†å™¨
      const discoverySuccess = await this.discoveryManager.init('com.example.wanwuhulian');
      
      if (dataSuccess && discoverySuccess) {
        // è®¾ç½®æ•°æ®å˜æ›´ç›‘å¬
        this.setupDataListeners();
        
        // æ£€æŸ¥è½¦æœºè¿æ¥çŠ¶æ€
        this.checkCarConnection();
        
        // è·å–åˆå§‹è½¦è¾†çŠ¶æ€
        await this.refreshVehicleStatus();
        
        hilog.info(0x0000, this.TAG, 'Watch app initialized successfully');
        promptAction.showToast({ message: 'è½¦è½½åŠ©æ‰‹å·²å°±ç»ª' });
      } else {
        throw new Error('Failed to initialize managers');
      }
    } catch (error) {
      hilog.error(0x0000, this.TAG, 'Failed to initialize watch app: %{public}s', JSON.stringify(error));
      promptAction.showToast({ message: 'åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·é‡è¯•' });
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * è®¾ç½®æ•°æ®ç›‘å¬å™¨
   */
  private setupDataListeners(): void {
    // è½¦è¾†æ•°æ®å˜æ›´ç›‘å¬
    this.dataManager.onDataChanged((data: any) => {
      this.handleVehicleDataUpdate(data);
    });
    
    // è¿æ¥çŠ¶æ€å˜æ›´ç›‘å¬
    this.dataManager.onConnectionStatusChanged((status: string) => {
      this.isConnected = status === 'connected';
      hilog.info(0x0000, this.TAG, 'Connection status changed: %{public}s', status);
    });
  }

  /**
   * æ£€æŸ¥è½¦æœºè¿æ¥çŠ¶æ€
   */
  private checkCarConnection(): void {
    // æ£€æŸ¥æ˜¯å¦å­˜åœ¨è½¦æœºè®¾å¤‡
    const carDevices = this.discoveryManager.getDevicesByType('car');
    this.isConnected = carDevices.length > 0;
  }

  /**
   * åˆ·æ–°è½¦è¾†çŠ¶æ€
   */
  private async refreshVehicleStatus(): Promise<void> {
    try {
      const data = await this.dataManager.readVehicleData();
      if (data) {
        this.vehicleStatus = {
          fuelLevel: data.fuelLevel || 0,
          tirePressure: data.tirePressure || 0,
          mileage: data.mileage || 0,
          speed: data.speed || 0,
          engineStatus: data.engineStatus || false,
          acStatus: data.acStatus || false,
          doorLocked: data.doorLocked !== undefined ? data.doorLocked : true,
          updateTime: data.lastUpdateTime || Date.now()
        };
      }
    } catch (error) {
      hilog.error(0x0000, this.TAG, 'Failed to refresh vehicle status: %{public}s', JSON.stringify(error));
    }
  }

  /**
   * å¤„ç†è½¦è¾†æ•°æ®æ›´æ–°
   */
  private handleVehicleDataUpdate(data: any): void {
    this.vehicleStatus = {
      fuelLevel: data.fuelLevel !== undefined ? data.fuelLevel : this.vehicleStatus.fuelLevel,
      tirePressure: data.tirePressure !== undefined ? data.tirePressure : this.vehicleStatus.tirePressure,
      mileage: data.mileage !== undefined ? data.mileage : this.vehicleStatus.mileage,
      speed: data.speed !== undefined ? data.speed : this.vehicleStatus.speed,
      engineStatus: data.engineStatus !== undefined ? data.engineStatus : this.vehicleStatus.engineStatus,
      acStatus: data.acStatus !== undefined ? data.acStatus : this.vehicleStatus.acStatus,
      doorLocked: data.doorLocked !== undefined ? data.doorLocked : this.vehicleStatus.doorLocked,
      updateTime: data.lastUpdateTime || Date.now()
    };
    
    hilog.debug(0x0000, this.TAG, 'Vehicle data updated from distributed storage');
  }

  /**
   * å¯åŠ¨æ—¶é’Ÿ
   */
  private startClock(): void {
    this.updateDateTime();
    this.clockTimer = setInterval(() => {
      this.updateDateTime();
    }, 1000);
  }

  /**
   * æ›´æ–°æ—¥æœŸæ—¶é—´æ˜¾ç¤º
   */
  private updateDateTime(): void {
    const now = new Date();
    this.currentTime = now.toLocaleTimeString([], { 
      hour: '2-digit', 
      minute: '2-digit' 
    });
    this.currentDate = now.toLocaleDateString([], {
      month: 'short',
      day: 'numeric',
      weekday: 'short'
    });
  }

  /**
   * å¯åŠ¨çŠ¶æ€æ›´æ–°å®šæ—¶å™¨
   */
  private startStatusUpdates(): void {
    this.statusTimer = setInterval(async () => {
      if (this.isConnected) {
        await this.refreshVehicleStatus();
      }
    }, 3000); // æ¯3ç§’æ›´æ–°ä¸€æ¬¡
  }

  /**
   * åˆ·æ–°è¿æ¥çŠ¶æ€
   */
  private async refreshConnection(): Promise<void> {
    try {
      // é‡æ–°æ£€æŸ¥è¿æ¥
      this.checkCarConnection();
      
      // åˆ·æ–°è½¦è¾†çŠ¶æ€
      await this.refreshVehicleStatus();
      
      promptAction.showToast({ 
        message: this.isConnected ? 'è¿æ¥æ­£å¸¸' : 'æœªæ£€æµ‹åˆ°è½¦æœºè®¾å¤‡' 
      });
    } catch (error) {
      hilog.error(0x0000, this.TAG, 'Failed to refresh connection: %{public}s', JSON.stringify(error));
    }
  }

  // ==================== æ ¸å¿ƒè·¨ç«¯æŒ‡ä»¤å‘é€é€»è¾‘ ====================
  
  /**
   * å¤„ç†ä¸€é”®å¯»è½¦æŒ‡ä»¤ - æ ¸å¿ƒè·¨ç«¯é€šä¿¡é€»è¾‘
   * é€šè¿‡åˆ†å¸ƒå¼å­˜å‚¨å‘è½¦æœºç«¯å‘é€å¯»è½¦æŒ‡ä»¤
   */
  private async handleFindCar(): Promise<void> {
    if (!this.isConnected) {
      promptAction.showToast({ message: 'æœªè¿æ¥åˆ°è½¦æœºè®¾å¤‡' });
      return;
    }

    try {
      // æ ¸å¿ƒä»£ç é€»è¾‘ï¼šé€šè¿‡åˆ†å¸ƒå¼æ•°æ®ç®¡ç†å™¨å‘é€å¯»è½¦æŒ‡ä»¤
      const success = await this.dataManager.storeVehicleData({
        findCarCommand: true,        // å¯»è½¦æŒ‡ä»¤æ ‡å¿—
        commandTimestamp: Date.now(), // æŒ‡ä»¤æ—¶é—´æˆ³
        sourceDevice: this.DEVICE_ID  // æŒ‡ä»¤æ¥æºè®¾å¤‡
      });

      if (success) {
        // è§†è§‰åé¦ˆ
        promptAction.showToast({ message: 'å¯»è½¦æŒ‡ä»¤å·²å‘é€' });
        hilog.info(0x0000, this.TAG, 'Find car command sent to car device via distributed storage');
        
        // å¯ä»¥æ·»åŠ éœ‡åŠ¨åé¦ˆ
        // vibrator.vibrate({ type: 'short' });
      } else {
        throw new Error('Failed to send find car command');
      }
    } catch (error) {
      hilog.error(0x0000, this.TAG, 'Failed to send find car command: %{public}s', JSON.stringify(error));
      promptAction.showToast({ message: 'å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•' });
    }
  }

  /**
   * å¤„ç†ç©ºè°ƒæ§åˆ¶æŒ‡ä»¤ - æ ¸å¿ƒè·¨ç«¯é€šä¿¡é€»è¾‘
   * ä¸€é”®å¼€å¯/å…³é—­ç©ºè°ƒï¼Œé»˜è®¤æ¸©åº¦25Â°C
   */
  private async handleAcControl(): Promise<void> {
    if (!this.isConnected) {
      promptAction.showToast({ message: 'æœªè¿æ¥åˆ°è½¦æœºè®¾å¤‡' });
      return;
    }

    try {
      const newAcStatus = !this.vehicleStatus.acStatus;
      const targetTemperature = 25; // é»˜è®¤25Â°C
      
      // æ ¸å¿ƒä»£ç é€»è¾‘ï¼šé€šè¿‡åˆ†å¸ƒå¼å­˜å‚¨å‘é€ç©ºè°ƒæ§åˆ¶æŒ‡ä»¤
      const success = await this.dataManager.storeVehicleData({
        acStatus: newAcStatus,           // ç©ºè°ƒå¼€å…³çŠ¶æ€
        acTemperature: targetTemperature, // ç›®æ ‡æ¸©åº¦
        commandTimestamp: Date.now(),
        sourceDevice: this.DEVICE_ID
      });

      if (success) {
        // æ›´æ–°æœ¬åœ°çŠ¶æ€
        this.vehicleStatus.acStatus = newAcStatus;
        
        const message = newAcStatus ? `ç©ºè°ƒå·²å¼€å¯ (${targetTemperature}Â°C)` : 'ç©ºè°ƒå·²å…³é—­';
        promptAction.showToast({ message: message });
        hilog.info(0x0000, this.TAG, 'AC control command sent: %{public}s', newAcStatus ? 'ON' : 'OFF');
      } else {
        throw new Error('Failed to send AC control command');
      }
    } catch (error) {
      hilog.error(0x0000, this.TAG, 'Failed to send AC control command: %{public}s', JSON.stringify(error));
      promptAction.showToast({ message: 'æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•' });
    }
  }

  /**
   * å¤„ç†è½¦é—¨æ§åˆ¶æŒ‡ä»¤ - æ ¸å¿ƒè·¨ç«¯é€šä¿¡é€»è¾‘
   * ä¸€é”®è§£é”/ä¸Šé”è½¦é—¨
   */
  private async handleDoorControl(): Promise<void> {
    if (!this.isConnected) {
      promptAction.showToast({ message: 'æœªè¿æ¥åˆ°è½¦æœºè®¾å¤‡' });
      return;
    }

    try {
      const newDoorStatus = !this.vehicleStatus.doorLocked;
      
      // æ ¸å¿ƒä»£ç é€»è¾‘ï¼šé€šè¿‡åˆ†å¸ƒå¼å­˜å‚¨å‘é€è½¦é—¨æ§åˆ¶æŒ‡ä»¤
      const success = await this.dataManager.storeVehicleData({
        doorLocked: newDoorStatus,       // è½¦é—¨é”å®šçŠ¶æ€
        commandTimestamp: Date.now(),
        sourceDevice: this.DEVICE_ID
      });

      if (success) {
        // æ›´æ–°æœ¬åœ°çŠ¶æ€
        this.vehicleStatus.doorLocked = newDoorStatus;
        
        const message = newDoorStatus ? 'è½¦é—¨å·²ä¸Šé”' : 'è½¦é—¨å·²è§£é”';
        promptAction.showToast({ message: message });
        hilog.info(0x0000, this.TAG, 'Door control command sent: %{public}s', newDoorStatus ? 'LOCKED' : 'UNLOCKED');
      } else {
        throw new Error('Failed to send door control command');
      }
    } catch (error) {
      hilog.error(0x0000, this.TAG, 'Failed to send door control command: %{public}s', JSON.stringify(error));
      promptAction.showToast({ message: 'æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•' });
    }
  }

  // ==================== è¾…åŠ©æ–¹æ³• ====================

  /**
   * è·å–æ²¹é‡é¢œè‰²çŠ¶æ€
   */
  private getFuelColor(): string {
    if (this.vehicleStatus.fuelLevel > 50) return '#4CAF50';  // ç»¿è‰² - å……è¶³
    if (this.vehicleStatus.fuelLevel > 20) return '#FFC107';  // é»„è‰² - ä¸€èˆ¬
    return '#F44336';                                         // çº¢è‰² - ä¸è¶³
  }

  /**
   * è·å–èƒå‹é¢œè‰²çŠ¶æ€
   */
  private getTirePressureColor(): string {
    const pressure = this.vehicleStatus.tirePressure;
    if (pressure >= 2.2 && pressure <= 2.5) return '#4CAF50'; // æ­£å¸¸èŒƒå›´
    if (pressure >= 1.8 && pressure <= 2.8) return '#FFC107'; // è­¦å‘ŠèŒƒå›´
    return '#F44336';                                         // å±é™©èŒƒå›´
  }

  /**
   * è·å–è½¦é€Ÿé¢œè‰²çŠ¶æ€
   */
  private getSpeedColor(): string {
    if (this.vehicleStatus.speed === 0) return '#AAAAAA';     // ç°è‰² - é™æ­¢
    if (this.vehicleStatus.speed < 60) return '#4CAF50';      // ç»¿è‰² - ä½é€Ÿ
    if (this.vehicleStatus.speed < 100) return '#FFC107';     // é»„è‰² - ä¸­é€Ÿ
    return '#F44336';                                         // çº¢è‰² - é«˜é€Ÿ
  }

  /**
   * æ¸…ç†èµ„æº
   */
  private cleanup(): void {
    // æ¸…ç†å®šæ—¶å™¨
    if (this.clockTimer !== -1) {
      clearInterval(this.clockTimer);
      this.clockTimer = -1;
    }
    
    if (this.statusTimer !== -1) {
      clearInterval(this.statusTimer);
      this.statusTimer = -1;
    }
    
    hilog.info(0x0000, this.TAG, 'Watch app cleaned up');
  }
}