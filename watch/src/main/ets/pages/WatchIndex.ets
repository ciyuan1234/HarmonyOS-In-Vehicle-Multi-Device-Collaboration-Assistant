/**
 * æ‰‹è¡¨ç«¯ä¸»é¡µ - è½¦è½½å¤šè®¾å¤‡ååŒåŠ©æ‰‹ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
 * 
 * æ ¸å¿ƒåŠŸèƒ½ï¼š
 * 1. è¿æ¥è½¦æœºæ¨¡æ‹Ÿå™¨ï¼ŒåŒæ­¥è½¦è¾†çŠ¶æ€æ•°æ®
 * 2. å¿«æ·æ“ä½œï¼šä¸€é”®å¯»è½¦ã€ç©ºè°ƒæ§åˆ¶ã€è½¦é—¨æ§åˆ¶
 * 3. UIé€‚é…æ‰‹è¡¨å°å±
 */

import { BusinessError } from '@kit.BasicServicesKit';
import { promptAction } from '@kit.ArkUI';
import { hilog } from '@kit.PerformanceAnalysisKit';

interface VehicleStatusData {
  fuelLevel: number;
  tirePressure: number;
  mileage: number;
  speed: number;
  engineStatus: boolean;
  acStatus: boolean;
  doorLocked: boolean;
  updateTime: number;
}

@Component
struct QuickActionButton {
  @Prop icon: string;
  @Prop label: string;
  @Prop backgroundColor: string;
  @Prop onPress: () => void;

  build() {
    Column() {
      Text(this.icon)
        .fontSize(28)
        .margin({ bottom: 4 })
      
      Text(this.label)
        .fontSize(12)
        .fontColor('#FFFFFF')
        .fontWeight(FontWeight.Medium)
        .textAlign(TextAlign.Center)
        .maxLines(1)
    }
    .width(70)
    .height(70)
    .backgroundColor(this.backgroundColor)
    .borderRadius(35)
    .justifyContent(FlexAlign.Center)
    .onClick(this.onPress)
    .shadow({ radius: 6, color: '#00000040', offsetX: 0, offsetY: 3 })
  }
}

@Component
struct StatusCard {
  @Prop title: string;
  @Prop value: string;
  @Prop unit: string;
  @Prop icon: string;
  @Prop statusColor: string;

  build() {
    Column() {
      Row() {
        Text(this.icon)
          .fontSize(20)
          .margin({ right: 8 })
        
        Text(this.title)
          .fontSize(14)
          .fontColor('#FFFFFF')
          .fontWeight(FontWeight.Medium)
          .layoutWeight(1)
      }
      .width('100%')
      .margin({ bottom: 8 })
      
      Row() {
        Text(this.value)
          .fontSize(24)
          .fontColor(this.statusColor)
          .fontWeight(FontWeight.Bold)
        
        Text(this.unit)
          .fontSize(12)
          .fontColor('#AAAAAA')
          .margin({ left: 4 })
      }
      .alignItems(VerticalAlign.Bottom)
    }
    .width('100%')
    .backgroundColor('#1E1E1E')
    .borderRadius(12)
    .padding(12)
    .shadow({ radius: 4, color: '#00000030', offsetX: 0, offsetY: 2 })
  }
}

@Entry
@Component
struct WatchIndex {
  @State currentTime: string = '';
  @State currentDate: string = '';
  @State isConnected: boolean = false;
  @State isLoading: boolean = true;
  
  @State vehicleStatus: VehicleStatusData = {
    fuelLevel: 75,
    tirePressure: 2.3,
    mileage: 320,
    speed: 0,
    engineStatus: false,
    acStatus: false,
    doorLocked: true,
    updateTime: Date.now()
  };

  private clockTimer: number = -1;
  private statusTimer: number = -1;
  private readonly TAG: string = 'WatchIndex';

  aboutToAppear(): void {
    this.initializeApp();
    this.startClock();
    this.startStatusUpdates();
  }

  aboutToDisappear(): void {
    this.cleanup();
  }

  build() {
    Column() {
      if (this.isLoading) {
        this.renderLoadingView();
      } else {
        this.renderStatusBar();
        this.renderTimeDisplay();
        this.renderVehicleStatus();
        this.renderQuickActions();
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#000000')
    .padding({ left: 16, right: 16, top: 20, bottom: 16 })
  }

  @Builder
  renderLoadingView() {
    Column() {
      Text('âŒš')
        .fontSize(40)
        .margin({ bottom: 12 })
      
      Text('è½¦è½½åŠ©æ‰‹')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor('#FFFFFF')
        .margin({ bottom: 8 })
      
      Text('æ­£åœ¨è¿æ¥è½¦æœº...')
        .fontSize(12)
        .fontColor('#AAAAAA')
      
      LoadingProgress()
        .width(24)
        .height(24)
        .color('#2196F3')
        .margin({ top: 16 })
    }
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
  }

  @Builder
  renderStatusBar() {
    Row() {
      Circle()
        .width(8)
        .height(8)
        .fill(this.isConnected ? '#4CAF50' : '#F44336')
        .margin({ right: 8 })
      
      Text(this.isConnected ? 'å·²è¿æ¥' : 'æœªè¿æ¥')
        .fontSize(12)
        .fontColor(this.isConnected ? '#4CAF50' : '#F44336')
        .layoutWeight(1)
      
      Button('ğŸ”„')
        .width(28)
        .height(28)
        .fontSize(14)
        .backgroundColor('#333333')
        .fontColor('#FFFFFF')
        .borderRadius(14)
        .onClick(() => {
          this.refreshConnection();
        })
    }
    .width('100%')
    .margin({ bottom: 16 })
  }

  @Builder
  renderTimeDisplay() {
    Column() {
      Text(this.currentTime)
        .fontSize(32)
        .fontWeight(FontWeight.Bold)
        .fontColor('#FFFFFF')
        .margin({ bottom: 4 })
      
      Text(this.currentDate)
        .fontSize(12)
        .fontColor('#AAAAAA')
    }
    .width('100%')
    .margin({ bottom: 20 })
    .alignItems(HorizontalAlign.Center)
  }

  @Builder
  renderVehicleStatus() {
    Column() {
      Row() {
        StatusCard({
          title: 'æ²¹é‡',
          value: this.vehicleStatus.fuelLevel.toString(),
          unit: '%',
          icon: 'â›½',
          statusColor: this.getFuelColor()
        })
        .layoutWeight(1)
        .margin({ right: 8 })
        
        StatusCard({
          title: 'èƒå‹',
          value: this.vehicleStatus.tirePressure.toFixed(1),
          unit: 'bar',
          icon: 'ğŸ›',
          statusColor: this.getTirePressureColor()
        })
        .layoutWeight(1)
      }
      .width('100%')
      .margin({ bottom: 12 })
      
      Row() {
        StatusCard({
          title: 'ç»­èˆª',
          value: this.vehicleStatus.mileage.toString(),
          unit: 'km',
          icon: 'ğŸ”‹',
          statusColor: '#4CAF50'
        })
        .layoutWeight(1)
        .margin({ right: 8 })
        
        StatusCard({
          title: 'è½¦é€Ÿ',
          value: this.vehicleStatus.speed.toString(),
          unit: 'km/h',
          icon: 'ğŸš€',
          statusColor: this.getSpeedColor()
        })
        .layoutWeight(1)
      }
      .width('100%')
    }
    .width('100%')
    .margin({ bottom: 24 })
  }

  @Builder
  renderQuickActions() {
    Grid() {
      GridItem() {
        QuickActionButton({
          icon: 'ğŸ”',
          label: 'å¯»è½¦',
          backgroundColor: '#9C27B0',
          onPress: this.handleFindCar
        })
      }
      
      GridItem() {
        QuickActionButton({
          icon: this.vehicleStatus.acStatus ? 'â„ï¸' : 'ğŸ§Š',
          label: this.vehicleStatus.acStatus ? 'å…³é—­ç©ºè°ƒ' : 'å¼€å¯ç©ºè°ƒ',
          backgroundColor: this.vehicleStatus.acStatus ? '#2196F3' : '#607D8B',
          onPress: this.handleAcControl
        })
      }
      
      GridItem() {
        QuickActionButton({
          icon: this.vehicleStatus.doorLocked ? 'ğŸ”’' : 'ğŸ”“',
          label: this.vehicleStatus.doorLocked ? 'è§£é”' : 'ä¸Šé”',
          backgroundColor: this.vehicleStatus.doorLocked ? '#4CAF50' : '#FF9800',
          onPress: this.handleDoorControl
        })
      }
    }
    .columnsTemplate('1fr 1fr 1fr')
    .columnsGap(12)
    .rowsGap(12)
  }

  private async initializeApp(): Promise<void> {
    try {
      this.isLoading = true;
      await new Promise(resolve => setTimeout(resolve, 2000));
      this.isConnected = true;
      this.isLoading = false;
      promptAction.showToast({ message: 'è½¦è½½åŠ©æ‰‹å·²å°±ç»ª' });
      hilog.info(0x0000, this.TAG, 'Watch app initialized successfully');
    } catch (error) {
      hilog.error(0x0000, this.TAG, 'Failed to initialize watch app');
    }
  }

  private startClock(): void {
    this.updateDateTime();
    this.clockTimer = setInterval(() => {
      this.updateDateTime();
    }, 1000);
  }

  private updateDateTime(): void {
    const now = new Date();
    this.currentTime = now.toLocaleTimeString([], { 
      hour: '2-digit', 
      minute: '2-digit' 
    });
    this.currentDate = now.toLocaleDateString([], {
      month: 'short',
      day: 'numeric',
      weekday: 'short'
    });
  }

  private startStatusUpdates(): void {
    this.statusTimer = setInterval(() => {
      if (this.isConnected) {
        this.simulateStatusUpdate();
      }
    }, 5000);
  }

  private simulateStatusUpdate(): void {
    this.vehicleStatus = {
      ...this.vehicleStatus,
      fuelLevel: Math.max(0, this.vehicleStatus.fuelLevel - Math.random() * 0.1),
      speed: this.vehicleStatus.engineStatus ? Math.floor(Math.random() * 80) : 0,
      updateTime: Date.now()
    };
  }

  private async refreshConnection(): Promise<void> {
    promptAction.showToast({ 
      message: this.isConnected ? 'è¿æ¥æ­£å¸¸' : 'æœªæ£€æµ‹åˆ°è½¦æœºè®¾å¤‡' 
    });
  }

  // æ ¸å¿ƒè·¨ç«¯æŒ‡ä»¤å‘é€é€»è¾‘
  private async handleFindCar(): Promise<void> {
    if (!this.isConnected) {
      promptAction.showToast({ message: 'æœªè¿æ¥åˆ°è½¦æœºè®¾å¤‡' });
      return;
    }

    try {
      // æ¨¡æ‹Ÿå‘é€å¯»è½¦æŒ‡ä»¤
      await new Promise(resolve => setTimeout(resolve, 500));
      promptAction.showToast({ message: 'å¯»è½¦æŒ‡ä»¤å·²å‘é€' });
      hilog.info(0x0000, this.TAG, 'Find car command sent to car device');
    } catch (error) {
      hilog.error(0x0000, this.TAG, 'Failed to send find car command');
      promptAction.showToast({ message: 'å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•' });
    }
  }

  private async handleAcControl(): Promise<void> {
    if (!this.isConnected) {
      promptAction.showToast({ message: 'æœªè¿æ¥åˆ°è½¦æœºè®¾å¤‡' });
      return;
    }

    try {
      const newAcStatus = !this.vehicleStatus.acStatus;
      this.vehicleStatus.acStatus = newAcStatus;
      
      const message = newAcStatus ? 'ç©ºè°ƒå·²å¼€å¯ (25Â°C)' : 'ç©ºè°ƒå·²å…³é—­';
      promptAction.showToast({ message: message });
      hilog.info(0x0000, this.TAG, 'AC control command sent');
    } catch (error) {
      hilog.error(0x0000, this.TAG, 'Failed to send AC control command');
      promptAction.showToast({ message: 'æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•' });
    }
  }

  private async handleDoorControl(): Promise<void> {
    if (!this.isConnected) {
      promptAction.showToast({ message: 'æœªè¿æ¥åˆ°è½¦æœºè®¾å¤‡' });
      return;
    }

    try {
      const newDoorStatus = !this.vehicleStatus.doorLocked;
      this.vehicleStatus.doorLocked = newDoorStatus;
      
      const message = newDoorStatus ? 'è½¦é—¨å·²ä¸Šé”' : 'è½¦é—¨å·²è§£é”';
      promptAction.showToast({ message: message });
      hilog.info(0x0000, this.TAG, 'Door control command sent');
    } catch (error) {
      hilog.error(0x0000, this.TAG, 'Failed to send door control command');
      promptAction.showToast({ message: 'æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•' });
    }
  }

  private getFuelColor(): string {
    if (this.vehicleStatus.fuelLevel > 50) return '#4CAF50';
    if (this.vehicleStatus.fuelLevel > 20) return '#FFC107';
    return '#F44336';
  }

  private getTirePressureColor(): string {
    const pressure = this.vehicleStatus.tirePressure;
    if (pressure >= 2.2 && pressure <= 2.5) return '#4CAF50';
    if (pressure >= 1.8 && pressure <= 2.8) return '#FFC107';
    return '#F44336';
  }

  private getSpeedColor(): string {
    if (this.vehicleStatus.speed === 0) return '#AAAAAA';
    if (this.vehicleStatus.speed < 60) return '#4CAF50';
    if (this.vehicleStatus.speed < 100) return '#FFC107';
    return '#F44336';
  }

  private cleanup(): void {
    if (this.clockTimer !== -1) {
      clearInterval(this.clockTimer);
      this.clockTimer = -1;
    }
    
    if (this.statusTimer !== -1) {
      clearInterval(this.statusTimer);
      this.statusTimer = -1;
    }
    
    hilog.info(0x0000, this.TAG, 'Watch app cleaned up');
  }
}