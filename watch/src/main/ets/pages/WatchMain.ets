import { BusinessError } from '@kit.BasicServicesKit';
import { promptAction } from '@kit.ArkUI';
import { WatchActionButton } from '../components/WatchActionButton';
import { WatchVehicleStatus } from '../components/WatchVehicleStatus';
import { VehicleAssistantManager } from '../../../shared/src/main/ets/manager/VehicleAssistantManager';
import { VehicleStatus, ControlCommand } from '../../../shared/src/main/ets/model/DeviceModel';

@Entry
@Component
struct WatchMain {
  @State currentTime: string = '';
  @State vehicleStatus: VehicleStatus = {
    speed: 0,
    engineStatus: false,
    fuelLevel: 80,
    temperature: 22,
    doorLocked: true,
    latitude: 39.9042,
    longitude: 116.4074,
    updateTime: Date.now()
  };
  @State isLoading: boolean = true;
  
  private vehicleManager: VehicleAssistantManager = VehicleAssistantManager.getInstance();
  private statusRef: WatchVehicleStatus | null = null;
  private timerId: number = -1;

  aboutToAppear(): void {
    this.initializeApp();
    this.startClock();
  }

  aboutToDisappear(): void {
    this.cleanup();
  }

  build() {
    Column() {
      if (this.isLoading) {
        this.renderLoadingView()
      } else {
        // æ—¶é—´æ˜¾ç¤º
        this.renderTimeDisplay()
        
        // è½¦è¾†çŠ¶æ€æ¦‚è§ˆ
        this.renderVehicleOverview()
        
        // å¿«æ·æ“ä½œæŒ‰é’®
        this.renderQuickActions()
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#000000')
    .padding(12)
  }

  /**
   * æ¸²æŸ“åŠ è½½è§†å›¾
   */
  @Builder
  renderLoadingView() {
    Column() {
      Text('âŒš')
        .fontSize(32)
        .margin({ bottom: 8 })
      
      Text('åˆå§‹åŒ–ä¸­...')
        .fontSize(12)
        .fontColor('#AAAAAA')
    }
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
  }

  /**
   * æ¸²æŸ“æ—¶é—´æ˜¾ç¤º
   */
  @Builder
  renderTimeDisplay() {
    Column() {
      Text(this.currentTime)
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .fontColor('#FFFFFF')
        .margin({ bottom: 4 })
      
      Text('è½¦è½½åŠ©æ‰‹')
        .fontSize(12)
        .fontColor('#AAAAAA')
    }
    .width('100%')
    .margin({ bottom: 16 })
    .alignItems(HorizontalAlign.Center)
  }

  /**
   * æ¸²æŸ“è½¦è¾†çŠ¶æ€æ¦‚è§ˆ
   */
  @Builder
  renderVehicleOverview() {
    WatchVehicleStatus({
      vehicleStatus: this.vehicleStatus
    })
    .width('100%')
    .margin({ bottom: 16 })
  }

  /**
   * æ¸²æŸ“å¿«æ·æ“ä½œæŒ‰é’®
   */
  @Builder
  renderQuickActions() {
    Grid() {
      // å¯åŠ¨/åœæ­¢å‘åŠ¨æœº
      GridItem() {
        WatchActionButton({
          icon: this.vehicleStatus.engineStatus ? 'â¹ï¸' : 'â–¶ï¸',
          label: this.vehicleStatus.engineStatus ? 'åœæ­¢' : 'å¯åŠ¨',
          backgroundColor: this.vehicleStatus.engineStatus ? '#F44336' : '#4CAF50',
          command: this.vehicleStatus.engineStatus ? ControlCommand.STOP_ENGINE : ControlCommand.START_ENGINE,
          onPress: this.handleQuickAction
        })
      }
      
      // é”è½¦/è§£é”
      GridItem() {
        WatchActionButton({
          icon: this.vehicleStatus.doorLocked ? 'ğŸ”“' : 'ğŸ”’',
          label: this.vehicleStatus.doorLocked ? 'è§£é”' : 'é”è½¦',
          backgroundColor: this.vehicleStatus.doorLocked ? '#4CAF50' : '#FF9800',
          command: this.vehicleStatus.doorLocked ? ControlCommand.UNLOCK_DOOR : ControlCommand.LOCK_DOOR,
          onPress: this.handleQuickAction
        })
      }
      
      // ç©ºè°ƒæ§åˆ¶
      GridItem() {
        WatchActionButton({
          icon: 'â„ï¸',
          label: 'ç©ºè°ƒ',
          backgroundColor: '#2196F3',
          command: ControlCommand.OPEN_AC,
          onPress: this.handleQuickAction
        })
      }
      
      // å¯»è½¦
      GridItem() {
        WatchActionButton({
          icon: 'ğŸ”',
          label: 'å¯»è½¦',
          backgroundColor: '#9C27B0',
          command: ControlCommand.NAVIGATE_TO,
          onPress: this.handleQuickAction
        })
      }
      
      // éŸ³ä¹æ§åˆ¶
      GridItem() {
        WatchActionButton({
          icon: 'ğŸµ',
          label: 'éŸ³ä¹',
          backgroundColor: '#FF5722',
          command: ControlCommand.PLAY_MUSIC,
          onPress: this.handleQuickAction
        })
      }
      
      // åˆ·æ–°çŠ¶æ€
      GridItem() {
        WatchActionButton({
          icon: 'ğŸ”„',
          label: 'åˆ·æ–°',
          backgroundColor: '#607D8B',
          command: ControlCommand.NAVIGATE_TO, // ä½¿ç”¨å ä½å‘½ä»¤
          onPress: this.refreshStatus
        })
      }
    }
    .columnsTemplate('1fr 1fr 1fr')
    .rowsTemplate('1fr 1fr')
    .columnsGap(8)
    .rowsGap(8)
    .layoutWeight(1)
  }

  /**
   * åˆå§‹åŒ–åº”ç”¨ç¨‹åº
   */
  private async initializeApp(): Promise<void> {
    try {
      this.isLoading = true;
      
      // åˆå§‹åŒ–è½¦è¾†åŠ©æ‰‹ç®¡ç†å™¨
      const success = await this.vehicleManager.init(
        'com.example.wanwuhulian',
        'watch_device_' + Date.now()
      );
      
      if (success) {
        // è®¾ç½®å›è°ƒç›‘å¬
        this.setupListeners();
        
        // è·å–åˆå§‹çŠ¶æ€
        this.refreshStatus();
        
        console.info('Watch app initialized successfully');
      }
    } catch (error) {
      console.error('Watch app initialization failed:', error);
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * è®¾ç½®ç›‘å¬å™¨
   */
  private setupListeners(): void {
    // è½¦è¾†çŠ¶æ€å˜åŒ–ç›‘å¬
    this.vehicleManager.setVehicleStatusListener((status) => {
      this.vehicleStatus = { ...status };
      // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
      if (this.statusRef) {
        this.statusRef.updateStatus(status);
      }
    });
  }

  /**
   * å¯åŠ¨æ—¶é’Ÿ
   */
  private startClock(): void {
    this.updateTime();
    this.timerId = setInterval(() => {
      this.updateTime();
    }, 1000);
  }

  /**
   * æ›´æ–°æ—¶é—´æ˜¾ç¤º
   */
  private updateTime(): void {
    const now = new Date();
    this.currentTime = now.toLocaleTimeString([], { 
      hour: '2-digit', 
      minute: '2-digit' 
    });
  }

  /**
   * å¤„ç†å¿«æ·æ“ä½œ
   */
  private handleQuickAction = (command: ControlCommand): void => {
    console.info('Watch quick action:', command);
    
    // å‘é€å‘½ä»¤
    this.vehicleManager.sendCommand(command)
      .then(success => {
        if (success) {
          // éœ‡åŠ¨åé¦ˆ
          // è¿™é‡Œå¯ä»¥æ·»åŠ éœ‡åŠ¨åé¦ˆ
          console.info('Command sent successfully');
        }
      })
      .catch(error => {
        console.error('Failed to send command:', error);
      });
  }

  /**
   * åˆ·æ–°è½¦è¾†çŠ¶æ€
   */
  private refreshStatus = (): void => {
    // è·å–æœ€æ–°è½¦è¾†çŠ¶æ€
    const status = this.vehicleManager.getCurrentVehicleStatus();
    this.vehicleStatus = { ...status };
    
    console.info('Vehicle status refreshed');
  }

  /**
   * æ¸…ç†èµ„æº
   */
  private cleanup(): void {
    if (this.timerId !== -1) {
      clearInterval(this.timerId);
      this.timerId = -1;
    }
  }
}